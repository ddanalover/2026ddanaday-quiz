<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë³„ë¹›ë…¸íŠ¸: ì¼ë³¸ì–´ ë½€ê°œê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Jua&family=Kosugi+Maru&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-body: #E9ECFF;
      --bg-game: #FFFDF3;
      --primary: #A889D6;      /* lavender */
      --secondary: #FFD54F;    /* yellow */
      --border: 4px solid #000;
    }

    html, body {
      margin: 0; padding: 0; height: 100vh;
      background-color: var(--bg-body);
      font-family: 'Jua', 'Kosugi Maru', sans-serif;
      image-rendering: pixelated;
      display: grid; place-items: center; overflow: hidden;
    }

    #app {
      width: 95vw; max-width: 400px; height: 95vh; max-height: 711px;
      background: var(--bg-game); border: var(--border); border-radius: 12px;
      box-shadow: 12px 12px 0px rgba(0,0,0,0.12);
      display: flex; flex-direction: column; position: relative; overflow: hidden;
    }

    .hidden { display: none !important; }

    header {
      background: var(--primary); padding: 15px; color: #fff;
      font-size: 1.2rem; text-align: center; border-bottom: var(--border); flex-shrink: 0;
    }

    .progress-bar { height: 16px; background: #fff; border-bottom: var(--border); flex-shrink: 0; }
    #progress-fill { height: 100%; width: 0%; background: var(--secondary); transition: 0.3s; }

    .content {
      flex: 1; display: flex; flex-direction: column;
      padding: 30px 20px 20px 20px; box-sizing: border-box; overflow: hidden;
    }

    /* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */
    .nav-footer {
      padding: 15px 20px; border-top: 2px dashed #ccc;
      display: flex; justify-content: center; gap: 12px; flex-shrink: 0; background: #fff;
    }

    .btn-pixel {
      padding: 18px; background: var(--primary); color: #fff; border: var(--border);
      font-family: inherit; font-size: 1.1rem; cursor: pointer;
      box-shadow: inset -4px -4px 0px rgba(0,0,0,0.3); border-radius: 10px; outline: none;
    }
    .btn-opt { background: #fff; color: #000; box-shadow: 4px 4px 0px rgba(0,0,0,0.1); }
    .btn-nav { flex: 1; padding: 12px; font-size: 1rem; }

    .spacer { flex: 1; min-height: 10px; }

    ruby rt {
      font-size: 0.7rem; color: #6c3483; font-family: 'Kosugi Maru', sans-serif;
      font-weight: bold; transform: translateY(-1px);
    }

    .home-star {
      font-size: 8.5rem; margin-bottom: 10px;
      animation: starFloat 2.5s infinite ease-in-out;
      filter: drop-shadow(0 0 20px rgba(253, 216, 53, 0.7));
    }
    @keyframes starFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(15deg); } }

    .main-title { font-size: 2.8rem; color: var(--primary); margin-bottom: 5px; text-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
    .sub-title { font-size: 1.1rem; color: #888; margin-bottom: 40px; letter-spacing: 1.5px; }

    .quiz-card {
      background: #fff; border: var(--border); padding: 35px 15px;
      text-align: center; position: relative; border-radius: 10px; flex-shrink: 0;
    }
    .q-tag {
      position: absolute; top: -16px; left: 50%; transform: translateX(-50%);
      background: var(--secondary); border: var(--border); padding: 6px 12px; font-size: 0.9rem;
    }
    .question { font-size: 1.4rem; line-height: 1.6; color: #333; word-break: keep-all; }

    .options { display: grid; gap: 15px; width: 100%; flex-shrink: 0; }

    #feedback-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    #feedback-overlay.show { display: flex !important; }
    .modal { background: #fff; border: var(--border); width: 85%; max-height: 80%; display: flex; flex-direction: column; padding: 20px; border-radius: 15px; }
    .f-scroll { flex: 1; overflow-y: auto; background: #FFF9C4; border: 2px dashed var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 10px; }

    .score-box { background: #fff; border: var(--border); padding: 15px; text-align: center; border-radius: 10px; flex-shrink: 0; }
    .review-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex: 1; min-height: 0; }
    .review-item { background: #fff; border: 2px solid var(--primary); padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; }

    /* í•´ì„¤ì§‘ ì „ìš© ìŠ¤íƒ€ì¼ */
    .label{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:0;border-radius:12px;font-weight:900;font-size:0.95rem;margin-top:14px;}
    .label.bad{background:rgba(231,76,60,0.10);color:#C0392B;}
    .label.why{background:rgba(142,68,173,0.10);color:#6C3483;border-left:6px solid #8E44AD;}
    .label.good{background:rgba(39,174,96,0.10);color:#1E8449;border-left:6px solid #27AE60;}
    .label.up{background:rgba(149,165,166,0.14);color:#2c2c2c;border-left:6px solid #7f8c8d;}
    .label.sum{background:rgba(253,216,53,0.16);color:#2c2c2c;border-left:6px solid #FDD835;}
    .section-block{margin-top:8px; line-height:1.75; text-align:left;}
    .sum-box{margin-top:10px; padding:12px; border:var(--border); border-radius:14px; background:#fff;}
  </style>
</head>

<body>
<div id="app">

  <div id="screen-home" class="content" style="justify-content:center; align-items:center; background: radial-gradient(circle, #FFFDE7 0%, #F5F7FF 100%);">
    <div class="home-star">ğŸŒŸ</div>
    <div class="main-title">ë³„ë¹›ë…¸íŠ¸</div>
    <div class="sub-title">ğŸ’¥ì¼ë³¸ì–´ ê³µë¶€ ë½€ê°œê¸°ğŸ’¥</div>
    <button class="btn-pixel" style="width:85%;" onclick="showScreen('screen-category')">ë„ì „ ì‹œì‘!</button>
  </div>

  <div id="screen-category" class="hidden">
    <header>ë¶„ì•¼ ì„ íƒ</header>
    <div class="content" style="justify-content:center;">
      <div style="display:grid; gap:20px;">
        <button class="btn-pixel" style="background:#F39C12" onclick="showKanjiCats()">ğŸ‰ í•œì</button>
        <button class="btn-pixel" style="background:#3498DB" onclick="startQuiz('expression')">ğŸ“– í‘œí˜„</button>
        <button class="btn-pixel" style="background:#8E44AD" onclick="openExplainMenu()">ğŸ“š í•´ì„¤ì§‘</button>
      </div>
    </div>
    <div class="nav-footer">
      <button class="btn-pixel btn-opt btn-nav" onclick="showScreen('screen-home')">í™ˆìœ¼ë¡œ</button>
    </div>
  </div>

  <div id="screen-kanji-cat" class="hidden">
    <header>í•œì ì¹´í…Œê³ ë¦¬</header>
    <div class="content" style="justify-content:center;">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
        <button class="btn-pixel btn-opt" onclick="startKanjiSub('ê³µì—°Â·í–‰ì‚¬')">ğŸŸ ê³µì—°</button>
        <button class="btn-pixel btn-opt" onclick="startKanjiSub('í˜¸í…”Â·ìˆ™ë°•')">ğŸ¨ í˜¸í…”</button>
        <button class="btn-pixel btn-opt" onclick="startKanjiSub('ì‹ë‹¹Â·ì¹´í˜')">ğŸœ ì‹ë‹¹</button>
        <button class="btn-pixel btn-opt" onclick="startKanjiSub('ì‡¼í•‘')">ğŸ› ì‡¼í•‘</button>
        <button class="btn-pixel btn-opt" onclick="startKanjiSub('êµí†µÂ·ì´ë™')">ğŸš¦ êµí†µ</button>
        <button class="btn-pixel btn-opt" onclick="startKanjiSub('ê³„ì ˆÂ·ë‚ ì”¨')">ğŸŒ¦ ë‚ ì”¨</button>
      </div>
    </div>
    <div class="nav-footer">
      <button class="btn-pixel btn-opt btn-nav" onclick="showScreen('screen-category')">ë’¤ë¡œ ê°€ê¸°</button>
    </div>
  </div>

  <div id="screen-explain" class="hidden">
    <header id="explain-header">í•´ì„¤ì§‘</header>
    <div class="content">
      <div id="explain-cat" style="display:grid; gap:15px; margin-top:10px;">
        <button class="btn-pixel" style="background:#FFB74D" onclick="openExplainList('ì¡°ì‚¬ ì‚¬ìš©')">ğŸ“ ì¡°ì‚¬</button>
        <button class="btn-pixel" style="background:#81D4FA" onclick="openExplainList('ê²½ì–´ì™€ í†¤')">ğŸ™‡ ê²½ì–´</button>
        <button class="btn-pixel" style="background:#A5D6A7" onclick="openExplainList('ë‹¨ì–´ ì„ íƒ')">ğŸ ë‹¨ì–´</button>
      </div>
      <div id="explain-list" class="hidden" style="flex:1; overflow-y:auto;">
        <div id="explain-list-scroll"></div>
      </div>
      <div id="explain-viewer" class="hidden" style="flex:1; display:flex; flex-direction:column;">
        <div class="quiz-card" style="padding:15px; text-align:left; margin-bottom:10px;">
          <div id="explain-card-title" class="question" style="font-size:1.1rem;"></div>
          <div id="explain-page-indicator" style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;">1/4</div>
        </div>
        <div id="explain-page-scroll" style="flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;">
          <div class="quiz-card" style="padding:15px; text-align:left;">
            <div id="explain-page-body" style="font-family:'Noto Sans KR',sans-serif; font-size:1rem; line-height:1.7;"></div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
          <button class="btn-pixel" onclick="prevExplainPage()">â—€ ì´ì „</button>
          <button class="btn-pixel" onclick="nextExplainPage()">ë‹¤ìŒ â–¶</button>
        </div>
      </div>
    </div>
    <div class="nav-footer">
      <button class="btn-pixel btn-opt btn-nav" id="btn-explain-back" onclick="handleExplainBack()">ë’¤ë¡œ ê°€ê¸°</button>
    </div>
  </div>

  <div id="screen-quiz" class="hidden">
    <header id="quiz-header">ì§„í–‰ ì¤‘</header>
    <div class="progress-bar"><div id="progress-fill"></div></div>
    <div class="content">
      <div class="quiz-card">
        <span class="q-tag" id="q-label">STEP 01</span>
        <div id="q-text" class="question"></div>
      </div>
      <div class="spacer"></div>
      <div class="options">
        <button class="btn-pixel btn-opt" id="opt0"></button>
        <button class="btn-pixel btn-opt" id="opt1"></button>
      </div>
    </div>
    <div class="nav-footer">
      <button class="btn-pixel btn-opt btn-nav" onclick="quitQuiz()">ê·¸ë§Œ í’€ê¸°</button>
    </div>
  </div>

  <div id="screen-result" class="hidden">
    <header>ê²°ê³¼ ë¦¬í¬íŠ¸</header>
    <div class="content" style="justify-content: flex-start;">
      <div class="score-box">
        ë³„ ê°œìˆ˜: <span id="res-c" style="color:var(--primary); font-size:2.2rem;">0</span>/5
      </div>
      <div id="review-list" class="review-list"></div>
    </div>
    <div class="nav-footer">
      <button class="btn-pixel btn-nav" style="background:#8E44AD;" onclick="retryCurrentQuiz()">ë‹¤ì‹œ í•˜ê¸°</button>
      <button class="btn-pixel btn-opt btn-nav" onclick="showScreen('screen-category')">ë¶„ì•¼ ì„ íƒ</button>
    </div>
  </div>

  <div id="feedback-overlay">
    <div class="modal">
      <span id="f-mark" style="font-size:3.5rem; text-align:center;">ğŸŒŸ</span>
      <div id="f-title" style="font-size: 1.4rem; font-weight: bold; text-align:center; margin:10px 0;"></div>
      <div class="f-scroll"><div id="f-exp" style="font-family:'Noto Sans KR',sans-serif; line-height:1.8;"></div></div>
      <button class="btn-pixel" onclick="handleContinue()">ê³„ì†í•˜ê¸° â–¶</button>
    </div>
  </div>

</div>

<script>
  var masterDB = { kanji: [], expression: [] };
  var masterExplainDB = [];
</script>
<script src="data/kanji.js"></script>
<script src="data/expression.js"></script>
<script src="data/explain.js"></script>

<script>
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSnd(t) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const n = audioCtx.currentTime;
    if(t==='c'){ o.type='square'; o.frequency.setValueAtTime(659,n); o.frequency.setValueAtTime(987,n+0.1); g.gain.setValueAtTime(0.1,n); }
    else { o.type='sawtooth'; o.frequency.setValueAtTime(150,n); o.frequency.exponentialRampToValueAtTime(50, n+0.4); g.gain.setValueAtTime(0.1,n); }
    o.start(n); o.stop(n+0.4);
  }

  let curCat = '', qSet = [], history = [], curIdx = 0, score = 0;
  let explainCatName = '', explainList = [], explainCardIndex = 0, explainPageIndex = 0;

  function showScreen(id) {
    ['screen-home','screen-category','screen-kanji-cat','screen-quiz','screen-result','screen-explain'].forEach(s => {
      document.getElementById(s).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
    document.getElementById('feedback-overlay').classList.remove('show');
  }

  // í€´ì¦ˆ ë¡œì§
  function startQuiz(cat, isRetry=false) {
    curCat = cat;
    if (cat === 'kanji') { showKanjiCats(); return; }
    const db = window.masterDB[cat];
    if (!db || db.length === 0) { alert("ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); return; }
    if (!isRetry) qSet = [...db].sort(() => 0.5 - Math.random()).slice(0, 5);
    curIdx = 0; score = 0; history = [];
    document.getElementById('quiz-header').innerText = cat==='expression' ? 'ğŸ“– í‘œí˜„' : 'ğŸ‰ í•œì';
    showScreen('screen-quiz');
    renderQuiz();
  }

  function showKanjiCats() { showScreen('screen-kanji-cat'); }

  function startKanjiSub(catName) {
    curCat = 'kanji';
    const all = window.masterDB.kanji || [];
    const filtered = all.filter(x => (x.cat || '') === catName);
    if (!filtered.length) { alert("ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
    qSet = [...filtered].sort(() => 0.5 - Math.random()).slice(0, 5);
    curIdx = 0; score = 0; history = [];
    document.getElementById('quiz-header').innerText = `ğŸ‰ í•œì Â· ${catName}`;
    showScreen('screen-quiz');
    renderQuiz();
  }

  function renderQuiz() {
    const d = qSet[curIdx];
    let opts = [
      { text: (d.o ? d.o[0] : d.options[0]), isCorrect: ((d.a ?? d.answer) === 0) },
      { text: (d.o ? d.o[1] : d.options[1]), isCorrect: ((d.a ?? d.answer) === 1) }
    ].sort(() => Math.random() - 0.5);
    document.getElementById('q-label').innerText = `STEP 0${curIdx + 1}`;
    document.getElementById('q-text').innerHTML = (d.q ?? d.question);
    document.getElementById('progress-fill').style.width = `${(curIdx / 5) * 100}%`;
    document.getElementById('opt0').innerHTML = `A. ${opts[0].text}`;
    document.getElementById('opt1').innerHTML = `B. ${opts[1].text}`;
    document.getElementById('opt0').onclick = () => handleCheck(opts[0].isCorrect);
    document.getElementById('opt1').onclick = () => handleCheck(opts[1].isCorrect);
  }

  function handleCheck(isC) {
    const d = qSet[curIdx];
    if(isC) { score++; playSnd('c'); } else { playSnd('w'); }
    history.push({...d, isC: isC});
    document.getElementById('f-mark').innerText = isC ? "ğŸŒŸ" : "â˜ï¸";
    document.getElementById('f-title').innerText = isC ? "ì •ë‹µì…ë‹ˆë‹¤!" : "ì•„ì‰¬ì›Œìš”!";
    document.getElementById('f-title').style.color = isC ? "var(--primary)" : "#E74C3C";
    document.getElementById('f-exp').innerHTML = `<b>ì •ë‹µ: ${(d.o ?? d.options)[d.a ?? d.answer]}</b><br><br>${d.e ?? d.explanation}`;
    document.getElementById('feedback-overlay').classList.add('show');
  }

  function handleContinue() {
    document.getElementById('feedback-overlay').classList.remove('show');
    curIdx++; if(curIdx < 5) renderQuiz(); else showFinalResult();
  }

  function showFinalResult() {
    showScreen('screen-result');
    document.getElementById('res-c').innerText = score;
    const list = document.getElementById('review-list');
    list.innerHTML = "";
    history.forEach((item, i) => {
      const div = document.createElement('div'); div.className = 'review-item';
      div.innerHTML = `<b>${i+1}. ${item.q ?? item.question}</b><br><span style="color:${item.isC?'var(--primary)':'#E74C3C'}">ì •ë‹µ: ${(item.o ?? item.options)[item.a ?? item.answer]}</span>`;
      div.onclick = () => {
        document.getElementById('f-title').innerText = "í•´ì„¤ ë³µìŠµ";
        document.getElementById('f-exp').innerHTML = `<b>ì •ë‹µ: ${(item.o ?? item.options)[item.a ?? item.answer]}</b><br><br>${item.e ?? item.explanation}`;
        document.getElementById('feedback-overlay').classList.add('show');
      };
      list.appendChild(div);
    });
  }

  function retryCurrentQuiz() { startQuiz(curCat, true); }
  function quitQuiz() { showScreen('screen-category'); }

  // í•´ì„¤ì§‘ ë¡œì§
  function openExplainMenu() { 
    showScreen('screen-explain'); 
    backToExplainCat(); 
  }

  function handleExplainBack() {
    const viewer = !document.getElementById('explain-viewer').classList.contains('hidden');
    const list = !document.getElementById('explain-list').classList.contains('hidden');
    if(viewer) openExplainList(explainCatName);
    else if(list) backToExplainCat();
    else showScreen('screen-category');
  }

  function backToExplainCat() { 
    explainCatName = '';
    document.getElementById('explain-cat').classList.remove('hidden');
    document.getElementById('explain-list').classList.add('hidden');
    document.getElementById('explain-viewer').classList.add('hidden');
    document.getElementById('explain-header').innerText = 'í•´ì„¤ì§‘';
  }

  function openExplainList(cat) {
    explainCatName = cat;
    explainList = window.masterExplainDB.filter(c => c.category === cat);
    const box = document.getElementById('explain-list-scroll');
    box.innerHTML = "";
    explainList.forEach((c, idx) => {
      const b = document.createElement('button');
      b.className = 'btn-pixel btn-opt'; b.style.width = "100%"; b.style.marginBottom = "12px";
      b.innerHTML = c.title; b.onclick = () => openExplainViewer(idx);
      box.appendChild(b);
    });
    document.getElementById('explain-cat').classList.add('hidden');
    document.getElementById('explain-list').classList.remove('hidden');
    document.getElementById('explain-header').innerText = cat;
  }

  function openExplainViewer(idx) {
    explainCardIndex = idx; explainPageIndex = 0;
    document.getElementById('explain-list').classList.add('hidden');
    document.getElementById('explain-viewer').classList.remove('hidden');
    renderExplainPage();
  }

  function renderExplainPage() {
    const card = explainList[explainCardIndex];
    document.getElementById('explain-card-title').innerHTML = card.title;
    document.getElementById('explain-page-indicator').innerText = `${explainPageIndex + 1}/4`;
    const pages = [
      `<div class="label bad">âŒ ì‹¤ìˆ˜</div><div class="section-block">${card.wrong}</div>`,
      `<div class="label why">ğŸ” ì´ìœ </div><div class="section-block">${card.why}</div>`,
      `<div class="label good">âœ… êµì •</div><div class="section-block"><ul>${(card.fix || []).map(x => `<li>${x}</li>`).join("")}</ul></div>`,
      `<div class="label sum">ğŸ§· í•µì‹¬</div><div class="sum-box">${card.summary || ""}</div>`
    ];
    document.getElementById('explain-page-body').innerHTML = pages[explainPageIndex];
    document.getElementById('explain-page-scroll').scrollTop = 0;
  }

  function prevExplainPage() { if (explainPageIndex > 0) { explainPageIndex--; renderExplainPage(); } }
  function nextExplainPage() { if (explainPageIndex < 3) { explainPageIndex++; renderExplainPage(); } }
</script>
</body>
</html>
