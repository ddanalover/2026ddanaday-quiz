<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë³„ë¹›ë…¸íŠ¸: ì¼ë³¸ì–´ ë½€ê°œê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Jua&family=Kosugi+Maru&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
            --bg-body: #E9ECFF;
            --bg-game: #FFFDF3;
            --primary: #A889D6;      /* lavender */
            --secondary: #FFD54F;    /* brighter yellow */    /* pastel yellow */
            --border: 4px solid #000;
        }

    html, body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-color: var(--bg-body);
            font-family: 'Jua', 'Kosugi Maru', sans-serif;
            image-rendering: pixelated;
        }

        body{
            display: grid;
            place-items: center;
            overflow: hidden;
        }

    #app {
            width: 95vw;
            max-width: 400px;
            height: 95vh;
            max-height: 711px;
            background: var(--bg-game);
            border: var(--border);
            border-radius: 12px;
            box-shadow: 12px 12px 0px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

    .hidden { display: none !important; }

    header {
      position: relative;
      background: var(--primary); padding: 15px; color: #fff;
      font-size: 1.2rem; text-align: center;
      border-bottom: var(--border); flex-shrink: 0;
    }

    .progress-bar { height: 16px; background: #fff; border-bottom: var(--border); flex-shrink: 0; }
    #progress-fill { height: 100%; width: 0%; background: var(--secondary); transition: 0.3s; }

    .content {
      flex: 1; display: flex; flex-direction: column;
      padding: 40px 20px 20px 20px;
      box-sizing: border-box;
      overflow: hidden;
      min-height: 0;
    }

    .spacer { flex: 1; min-height: 20px; }

    ruby rt {
      font-size: 0.7rem;
      color: #6c3483;
      font-family: 'Kosugi Maru', sans-serif;
      font-weight: bold;
      transform: translateY(-1px);
    }

    .home-star {
      font-size: 8.5rem;
      margin-bottom: 10px;
      animation: starFloat 2.5s infinite ease-in-out;
      filter: drop-shadow(0 0 20px rgba(253, 216, 53, 0.7));
    }
    @keyframes starFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(15deg); } }

    .main-title { font-size: 2.8rem; color: var(--primary); margin-bottom: 5px; text-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
    .sub-title { font-size: 1.1rem; color: #888; margin-bottom: 40px; letter-spacing: 1.5px; }

    .quiz-card {
      background: #fff; border: var(--border); padding: 35px 15px;
      text-align: center; position: relative; border-radius: 10px; flex-shrink: 0;
    }
    .q-tag {
      position: absolute; top: -16px; left: 50%; transform: translateX(-50%);
      background: var(--secondary); border: var(--border); padding: 6px 12px; font-size: 0.9rem;
    }
    .question { font-size: 1.4rem; line-height: 1.6; color: #333; word-break: keep-all; }

    .options { display: grid; gap: 15px; width: 100%; flex-shrink: 0; }

    .btn-pixel {
      padding: 18px; background: var(--primary); color: #fff; border: var(--border);
      font-family: inherit; font-size: 1.1rem; cursor: pointer;
      box-shadow: inset -4px -4px 0px rgba(0,0,0,0.3); border-radius: 10px; outline: none;
    }
    .btn-opt { background: #fff; color: #000; box-shadow: 6px 6px 0px rgba(0,0,0,0.1); }
    .btn-opt:active { background: var(--secondary); transform: translate(3px, 3px); box-shadow: none; }

    #feedback-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    #feedback-overlay.show { display: flex !important; }
    .modal { background: #fff; min-height:0; border: var(--border); width: 85%; max-height: 80%; display: flex; flex-direction: column; padding: 20px; border-radius: 15px; }
    .f-scroll { flex: 1; min-height: 0; overflow-y: auto; background: #FFF9C4; border: 2px dashed var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 10px; -webkit-overflow-scrolling:touch; touch-action:pan-y; }

    .score-box { background: #fff; border: var(--border); padding: 10px; text-align: center; border-radius: 10px; flex-shrink: 0; }
    .review-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex: 1; min-height: 0; padding-right: 5px; }
    .review-item { background: #fff; border: 2px solid var(--primary); padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; flex-shrink: 0; }
    .result-footer { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; flex-shrink: 0; }
    .btn-sm { padding: 12px 5px; font-size: 0.9rem; }

    /* ===== í•´ì„¤ì§‘ 4í˜ì´ì§€ êµ¬ì¡°ìš© ===== */
    .explain-item{width:100%; text-align:left;}
    .explain-scroll-area::-webkit-scrollbar{width:8px;}
    .explain-scroll-area::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.25); border-radius:10px;}

    .label{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:0;border-radius:12px;font-weight:900;font-size:0.95rem;margin-top:14px;}
    .label.bad{background:rgba(231,76,60,0.10);color:#C0392B;border-left:0;}
    .label.why{background:rgba(142,68,173,0.10);color:#6C3483;border-left:6px solid #8E44AD;}
    .label.good{background:rgba(39,174,96,0.10);color:#1E8449;border-left:6px solid #27AE60;}
    .label.up{background:rgba(149,165,166,0.14);color:#2c2c2c;border-left:6px solid #7f8c8d;}
    .label.sum{background:rgba(253,216,53,0.16);color:#2c2c2c;border-left:6px solid #FDD835;}

    .section-block{margin-top:8px; line-height:1.75; text-align:left; word-break:anywhere;}
    .section-block ul{margin:8px 0 0 18px; padding:0;}
    .section-block li{margin:8px 0;}
    .sum-box{margin-top:10px; padding:12px; border:var(--border); border-radius:14px; background:#fff; line-height:1.7;}
  </style>
</head>

<body>
<div id="app">

  <!-- HOME -->
  <div id="screen-home" class="content" style="justify-content:center; align-items:center; background: radial-gradient(circle, #FFFDE7 0%, #F5F7FF 100%);">
    <div class="home-star">ğŸŒŸ</div>
    <div class="main-title">ë³„ë¹›ë…¸íŠ¸</div>
    <div class="sub-title">ğŸ’¥ì¼ë³¸ì–´ ê³µë¶€ ë½€ê°œê¸°ğŸ’¥</div>
    <button class="btn-pixel" style="width:85%; background:var(--primary);" onclick="showScreen('screen-category')">ë„ì „ ì‹œì‘!</button>
  </div>

  <!-- CATEGORY -->
  <div id="screen-category" class="hidden">
    <header>ë¶„ì•¼ ì„ íƒ</header>
    <div class="content" style="justify-content:center;">
      <div style="display:grid; gap:20px;">
        <button class="btn-pixel" style="background:#8E44AD" onclick="showKanjiCats()">ğŸ‰&nbsp;í•œì</button>
        <button class="btn-pixel" style="background:#8E44AD" onclick="startQuiz('expression')">ğŸ“–&nbsp;í‘œí˜„</button>
        <button class="btn-pixel" style="background:#8E44AD" onclick="openExplainMenu()">ğŸ“š&nbsp;í•´ì„¤ì§‘</button>
      </div>
      <button class="btn-pixel btn-opt" style="margin-top:50px;" onclick="showScreen('screen-home')">í™ˆìœ¼ë¡œ</button>
    </div>
  </div>


  <!-- KANJI SUBCATEGORY -->
  <div id="screen-kanji-cat" class="hidden">
    <header>í•œì ì¹´í…Œê³ ë¦¬</header>
    <div class="content" style="justify-content:center;">
      <div style="display:grid; gap:14px;">
        <button class="btn-pixel" style="background:#FFB74D" onclick="startKanjiSub('ê³µì—°Â·í–‰ì‚¬')">ğŸŸ&nbsp;ê³µì—°Â·í–‰ì‚¬</button>
        <button class="btn-pixel" style="background:#FFD54F" onclick="startKanjiSub('í˜¸í…”Â·ìˆ™ë°•')">ğŸ¨&nbsp;í˜¸í…”Â·ìˆ™ë°•</button>
        <button class="btn-pixel" style="background:#A5D6A7" onclick="startKanjiSub('ì‹ë‹¹Â·ì¹´í˜')">ğŸœ&nbsp;ì‹ë‹¹Â·ì¹´í˜</button>
        <button class="btn-pixel" style="background:#81D4FA" onclick="startKanjiSub('ì‡¼í•‘')">ğŸ›&nbsp;ì‡¼í•‘</button>
        <button class="btn-pixel" style="background:#FFAB91" onclick="startKanjiSub('êµí†µÂ·ì´ë™')">ğŸš¦&nbsp;êµí†µÂ·ì´ë™</button>
        <button class="btn-pixel" style="background:#80DEEA" onclick="startKanjiSub('ê³„ì ˆÂ·ë‚ ì”¨')">ğŸŒ¦&nbsp;ê³„ì ˆÂ·ë‚ ì”¨</button>
      </div>
      <button class="btn-pixel btn-opt" style="width:60%; margin:18px auto 0 auto; display:block;" onclick="showScreen('screen-category')">ë’¤ë¡œê°€ê¸°</button>
    </div>
  </div>


  <!-- EXPLAIN (4 pages) -->
  <div id="screen-explain" class="hidden">
    <header>í•´ì„¤ì§‘</header>
    <div class="content" id="explain-root" style="padding-top:20px;">

      <!-- 1) ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
      <div id="explain-cat">
  <div style="display:grid; gap:15px; margin-top:18px;">
            <button class="btn-pixel" style="background:#FFB74D" onclick="openExplainList('ì¡°ì‚¬ ì‚¬ìš©')">ğŸ“&nbsp;ì¡°ì‚¬</button>
            <button class="btn-pixel" style="background:#81D4FA" onclick="openExplainList('ê²½ì–´ì™€ í†¤')">ğŸ™‡&nbsp;ê²½ì–´</button>
            <button class="btn-pixel" style="background:#A5D6A7" onclick="openExplainList('ë‹¨ì–´ ì„ íƒ')">ğŸ&nbsp;ë‹¨ì–´</button>
          </div>
          <div class="spacer"></div>
          <button class="btn-pixel btn-opt" style="width:60%; margin:18px auto 0 auto; display:block;" onclick="showScreen('screen-category')">ë’¤ë¡œê°€ê¸°</button>
        </div>
      </div>

      <!-- 2) íƒ€ì´í‹€ ë¦¬ìŠ¤íŠ¸ -->
      <div id="explain-list" class="hidden" style="display:flex; flex-direction:column; flex:1; min-height:0;">
        <div class="quiz-card" style="padding:16px 15px; text-align:left; flex-shrink:0;">
          <div id="explain-list-title" class="question" style="font-size:1.15rem; line-height:1.35;"></div>
          <div style="margin-top:8px; font-size:0.95rem; color:#666; line-height:1.4;">
            ì œëª©ì„ ëˆŒëŸ¬ í•´ì„¤ì„ ì½ì–´ì£¼ì„¸ìš”.
          </div>
        </div>

        <div id="explain-list-scroll" class="explain-scroll-area" style="flex:1; min-height:0; overflow-y:auto; margin-top:12px;">
        </div>

        <div class="explain-footer" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:auto; padding-top:18px; flex-shrink:0;">
          <button class="btn-pixel btn-opt" onclick="backToExplainCat()">ì¹´í…Œê³ ë¦¬</button>
          <button class="btn-pixel" style="background:#8E44AD" onclick="showScreen('screen-category')">ë‚˜ê°€ê¸°</button>
        </div>
      </div>

      <!-- 3) ì¹´ë“œ ë·°ì–´ (4í˜ì´ì§€ ê³ ì •) -->
      <div id="explain-viewer" class="hidden" style="display:flex; flex-direction:column; flex:1; min-height:0;">
        <div class="quiz-card" style="padding:16px 15px; text-align:left; flex-shrink:0;">
          <div id="explain-card-title" class="question" style="font-size:1.2rem; line-height:1.35;"></div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; color:#666; font-weight:bold;">
            <div id="explain-card-meta"></div>
            <div id="explain-page-indicator">1/4</div>
          </div>
        </div>

        <div id="explain-page-scroll" style="flex:1; min-height:0; overflow-y:auto; margin-top:12px; -webkit-overflow-scrolling:touch; touch-action:pan-y;">
          <div class="quiz-card" style="padding:18px 15px; text-align:left;">
            <div id="explain-page-body"
     style="font-family:'Noto Sans KR','Kosugi Maru',sans-serif;
            font-size:1.02rem;
            line-height:1.9;
            overflow-wrap:anywhere;
            word-break:normal;
            text-align:left;"></div>
          </div>
        </div>

        <div class="explain-footer" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:12px; flex-shrink:0;">
          <button class="btn-pixel" onclick="prevExplainPage()">â—€ ì´ì „</button>
          <button class="btn-pixel btn-opt" onclick="backToExplainList()">ëª©ë¡</button>
          <button class="btn-pixel" onclick="nextExplainPage()">ë‹¤ìŒ â–¶</button>
        </div>
      </div>

    </div>
  </div>

  <!-- QUIZ -->
  <div id="screen-quiz" class="hidden">
    <header id="quiz-header">ì§„í–‰ ì¤‘</header>
    <div class="progress-bar"><div id="progress-fill"></div></div>
    <div class="content">
      <div class="quiz-card">
        <span class="q-tag" id="q-label">STEP 01</span>
        <div class="question" id="q-text"></div>
      </div>

      <div class="spacer"></div>

      <div class="options">
        <button class="btn-pixel btn-opt" id="opt0"></button>
        <button class="btn-pixel btn-opt" id="opt1"></button>
      </div>

      <!-- ê·¸ë§Œí’€ê¸°: í•­ìƒ ì•„ë˜ -->
      <div style="margin-top:auto; padding-top:22px; display:flex; justify-content:center;">
        <button class="btn-pixel btn-opt" style="width:52%; background:#c9ced3; color:#000; padding:10px 8px; font-size:0.9rem;" onclick="quitQuiz()">ê·¸ë§Œí’€ê¸°</button>
      </div>
    </div>
  </div>

  <!-- FEEDBACK -->
  <div id="feedback-overlay">
    <div class="modal">
      <span id="f-mark" style="font-size:3.5rem; text-align:center;">ğŸŒŸ</span>
      <div id="f-title" style="font-size: 1.4rem; font-weight: bold; text-align:center; margin:10px 0;"></div>
      <div class="f-scroll"><div id="f-exp" style="font-family:'Noto Sans KR','Kosugi Maru',sans-serif; line-height:1.9; font-size:1.02rem; overflow-wrap:anywhere; word-break:normal; text-align:left;"></div></div>
      <button class="btn-pixel" onclick="handleContinue()">ê³„ì†í•˜ê¸° â–¶</button>
    </div>
  </div>

  <!-- RESULT -->
  <div id="screen-result" class="hidden">
    <header>ê²°ê³¼ ë¦¬í¬íŠ¸</header>
    <div class="content" style="justify-content: flex-start; padding-top: 20px;">
      <div class="score-box">
        ëª¨ì€ ë³„ ê°œìˆ˜: <span id="res-c" style="color:var(--primary); font-size:2.2rem;">0</span>/5
      </div>
      <div style="text-align:center; font-size:0.9rem; color:#666; margin-top: 5px;">(í´ë¦­í•˜ë©´ í•´ì„¤ì´ ë³´ì…ë‹ˆë‹¤)</div>
      <div id="review-list" class="review-list"></div>
      <div class="result-footer">
        <button class="btn-pixel btn-sm" style="background:#CFD8DC;" onclick="showScreen('screen-home')">ì²˜ìŒìœ¼ë¡œ</button>
        <button class="btn-pixel btn-sm" style="background:#81D4FA;" onclick="showScreen('screen-category')">ë¶„ì•¼ ì„ íƒ</button>
        <button class="btn-pixel btn-sm" onclick="retryCurrentQuiz()">ë‹¤ì‹œí’€ê¸°</button>
        <button class="btn-pixel btn-sm" style="background:#A5D6A7;" onclick="continuePlay()">ê³„ì†í’€ê¸°</button>
      </div>
    </div>
  </div>

</div>

<script src="data/kanji.js"></script>
<script src="data/expression.js"></script>
<script src="data/explain.js"></script>

<script>
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSnd(t) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const n = audioCtx.currentTime;
    if(t==='c'){
      o.type='square';
      o.frequency.setValueAtTime(659,n);
      o.frequency.setValueAtTime(987,n+0.1);
      g.gain.setValueAtTime(0.1,n);
    }else{
      o.type='sawtooth';
      o.frequency.setValueAtTime(150,n);
      o.frequency.exponentialRampToValueAtTime(50, n+0.4);
      g.gain.setValueAtTime(0.1,n);
    }
    o.start(n); o.stop(n+0.4);
  }

  let curCat = '', qSet = [], history = [], curIdx = 0, score = 0;

  function showScreen(id) {
    ['screen-home','screen-category','screen-kanji-cat','screen-quiz','screen-result','screen-explain'].forEach(s => {
      document.getElementById(s).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
    document.getElementById('feedback-overlay').classList.remove('show');
  }

  function startQuiz(cat, isRetry=false) {
    curCat = cat;
    if (cat === 'kanji') { showKanjiCats(); return; }
    if (!window.masterDB || !window.masterDB[cat] || window.masterDB[cat].length === 0) {
      alert("ë¬¸ì œê°€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!isRetry) qSet = [...window.masterDB[cat]].sort(() => 0.5 - Math.random()).slice(0, 5);
    curIdx = 0; score = 0; history = [];
    const t = {kanji:'ğŸ‰ í•œì', expression:'ğŸ“– í‘œí˜„'};
    document.getElementById('quiz-header').innerText = t[cat];
    showScreen('screen-quiz');
    renderQuiz();
  }

  // í•œì: í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ì„ íƒ í™”ë©´
  function showKanjiCats() {
    showScreen('screen-kanji-cat');
  }

  // í•œì: ì¹´í…Œê³ ë¦¬ë³„ 5ë¬¸í•­ ëœë¤
  function startKanjiSub(catName) {
    curCat = 'kanji';
    const all = (window.masterDB && window.masterDB.kanji) ? window.masterDB.kanji : [];
    const filtered = all.filter(x => (x.cat || '') === catName);
    if (!filtered.length) { alert("í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ë¬¸ì œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤."); return; }
    qSet = [...filtered].sort(() => 0.5 - Math.random()).slice(0, 5);
    curIdx = 0; score = 0; history = [];
    document.getElementById('quiz-header').innerText = `ğŸ‰ í•œì Â· ${catName}`;
    showScreen('screen-quiz');
    renderQuiz();
  }

  function renderQuiz() {
    const d = qSet[curIdx];
    if (!d) { showFinalResult(); return; }

    let optionsData = [
      { text: (d.o ? d.o[0] : d.options[0]), isCorrect: ((d.a !== undefined ? d.a : d.answer) === 0) },
      { text: (d.o ? d.o[1] : d.options[1]), isCorrect: ((d.a !== undefined ? d.a : d.answer) === 1) }
    ].sort(() => Math.random() - 0.5);

    document.getElementById('q-label').innerText = `STEP 0${curIdx + 1}`;
    document.getElementById('q-text').innerHTML = (d.q !== undefined ? d.q : d.question);
    document.getElementById('progress-fill').style.width = `${(curIdx / 5) * 100}%`;

    const b0 = document.getElementById('opt0');
    const b1 = document.getElementById('opt1');
    b0.innerHTML = `A. ${optionsData[0].text}`;
    b1.innerHTML = `B. ${optionsData[1].text}`;
    b0.onclick = function() { handleCheck(optionsData[0].isCorrect); };
    b1.onclick = function() { handleCheck(optionsData[1].isCorrect); };
  }

  function handleCheck(isC) {
    const d = qSet[curIdx];
    if(isC) { score++; playSnd('c'); } else { playSnd('w'); }
    history.push({...d, isC: isC});
    document.getElementById('f-mark').innerText = isC ? "ğŸŒŸ" : "â˜ï¸";
    document.getElementById('f-title').innerText = isC ? "ì •ë‹µì…ë‹ˆë‹¤!" : "ì•„ì‰¬ì›Œìš”!";
    document.getElementById('f-title').style.color = isC ? "var(--primary)" : "#E74C3C";
    const ansIdx = (d.a !== undefined ? d.a : d.answer);
    const opts = (d.o !== undefined ? d.o : d.options);
    const exp = (d.e !== undefined ? d.e : d.explanation);
    document.getElementById('f-exp').innerHTML = `<b>ì •ë‹µ: ${opts[ansIdx]}</b><br><br>${exp}`;
    document.getElementById('feedback-overlay').classList.add('show');
  }

  function handleContinue() {
    document.getElementById('feedback-overlay').classList.remove('show');
    curIdx++; if(curIdx < 5) renderQuiz(); else showFinalResult();
  }

  function showFinalResult() {
    showScreen('screen-result');
    document.getElementById('res-c').innerText = score;
    const list = document.getElementById('review-list');
    list.innerHTML = "";
    history.forEach((item, i) => {
      const div = document.createElement('div'); div.className = 'review-item';
      const qHtml = (item.q !== undefined ? item.q : item.question);
      const ansIdx2 = (item.a !== undefined ? item.a : item.answer);
      const opts2 = (item.o !== undefined ? item.o : item.options);
      div.innerHTML = `<b>${i+1}. ${qHtml}</b><br><span style="color:${item.isC?'var(--primary)':'#E74C3C'}">âœ… ì •ë‹µ: ${opts2[ansIdx2]}</span>`;
      div.onclick = () => {
        document.getElementById('f-title').innerText = "í•´ì„¤ ë³µìŠµ";
        const qHtml2 = (item.q !== undefined ? item.q : item.question);
        const ansIdx3 = (item.a !== undefined ? item.a : item.answer);
        const opts3 = (item.o !== undefined ? item.o : item.options);
        const exp3 = (item.e !== undefined ? item.e : item.explanation);
        document.getElementById('f-exp').innerHTML = `<b>ë¬¸ì œ: ${qHtml2}</b><br><br><b>ì •ë‹µ: ${opts3[ansIdx3]}</b><br><br>${exp3}`;
        document.getElementById('feedback-overlay').classList.add('show');
      };
      list.appendChild(div);
    });
  }

  function retryCurrentQuiz() { startQuiz(curCat, true); }
  function continuePlay() { startQuiz(curCat, false); }
  function quitQuiz() { showScreen('screen-category'); }

  // ===== í•´ì„¤ì§‘ (4í˜ì´ì§€ ê³ ì •) =====
  let explainCat = null;
  let explainList = [];
  let explainCardIndex = 0;
  let explainPageIndex = 0;

  function openExplainMenu() {
    showScreen('screen-explain');
    document.getElementById('explain-cat').classList.remove('hidden');
    document.getElementById('explain-list').classList.add('hidden');
    document.getElementById('explain-viewer').classList.add('hidden');
  }

  function backToExplainCat() {
    document.getElementById('explain-cat').classList.remove('hidden');
    document.getElementById('explain-list').classList.add('hidden');
    document.getElementById('explain-viewer').classList.add('hidden');
  }

  function openExplainList(categoryName) {
    explainCat = categoryName;
    const db = window.masterExplainDB || [];
    explainList = db.filter(c => c.category === categoryName);

    document.getElementById('explain-list-title').innerText =
      ({'ì¡°ì‚¬ ì‚¬ìš©':'ì¡°ì‚¬','ê²½ì–´ì™€ í†¤':'ê²½ì–´','ë‹¨ì–´ ì„ íƒ':'ë‹¨ì–´'}[categoryName] || categoryName);

    const box = document.getElementById('explain-list-scroll');
    box.innerHTML = "";
    explainList.forEach((c, idx) => {
      const b = document.createElement('button');
      b.className = 'btn-pixel btn-opt explain-item';
      b.style.marginBottom = "12px";
      b.innerHTML = c.title;
      b.onclick = () => openExplainViewer(idx);
      box.appendChild(b);
    });

    document.getElementById('explain-cat').classList.add('hidden');
    document.getElementById('explain-list').classList.remove('hidden');
    document.getElementById('explain-viewer').classList.add('hidden');
  }

  function backToExplainList() {
    document.getElementById('explain-cat').classList.add('hidden');
    document.getElementById('explain-list').classList.remove('hidden');
    document.getElementById('explain-viewer').classList.add('hidden');
  }

  function buildPages(card) {
    const p1 = `
      <div class="label bad">âŒ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜</div>
      <div class="section-block">${card.wrong}</div>
    `;
    const p2 = `
      <div class="label why">ğŸ” ì™œ ì–´ìƒ‰í• ê¹Œ</div>
      <div class="section-block">${card.why}</div>
    `;
    const fixList = (card.fix || []).map(x => `<li>${x}</li>`).join("");
    const p3 = `
      <div class="label good">âœ… ì´ë ‡ê²Œ ë§í•´ìš”</div>
      <div class="section-block"><ul>${fixList}</ul></div>
    `;
    const p4 = `
      <div class="label up">â• í•œ ë‹¨ê³„ ë”</div>
      <div class="section-block">${card.stepup || ""}</div>
      <div class="label sum">ğŸ§· í•µì‹¬ë§Œ</div>
      <div class="sum-box">${card.summary || ""}</div>
    `;
    return [p1, p2, p3, p4];
  }

  function openExplainViewer(idx) {
    explainCardIndex = idx;
    explainPageIndex = 0;
    document.getElementById('explain-cat').classList.add('hidden');
    document.getElementById('explain-list').classList.add('hidden');
    document.getElementById('explain-viewer').classList.remove('hidden');
    renderExplainPage();
  }

  function renderExplainPage() {
    const card = explainList[explainCardIndex];
    if (!card) return;

    document.getElementById('explain-card-title').innerHTML = card.title;
    document.getElementById('explain-card-meta').innerText =
      ({'ì¡°ì‚¬ ì‚¬ìš©':'ì¡°ì‚¬','ê²½ì–´ì™€ í†¤':'ê²½ì–´','ë‹¨ì–´ ì„ íƒ':'ë‹¨ì–´'}[explainCat] || explainCat);

    document.getElementById('explain-page-indicator').innerText = `${explainPageIndex + 1}/4`;
    const pages = buildPages(card);
    document.getElementById('explain-page-body').innerHTML = pages[explainPageIndex];

    const sc = document.getElementById('explain-page-scroll');
    if (sc) sc.scrollTop = 0;
  }

  function prevExplainPage() {
    if (explainPageIndex > 0) { explainPageIndex--; renderExplainPage(); return; }
    if (explainCardIndex > 0) { explainCardIndex--; explainPageIndex = 3; renderExplainPage(); }
  }

  function nextExplainPage() {
    if (explainPageIndex < 3) { explainPageIndex++; renderExplainPage(); return; }
    if (explainCardIndex < explainList.length - 1) { explainCardIndex++; explainPageIndex = 0; renderExplainPage(); }
  }
</script>

</body>
</html>
