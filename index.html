<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³„ë¹›ë…¸íŠ¸: ì¼ë³¸ì–´ ë½€ê°œê¸°</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #DDE2FF; 
            --bg-game: #FFFDE7; 
            --primary: #8E44AD; 
            --secondary: #FDD835; 
            --border: 4px solid #000;
        }

        html, body {
            margin: 0; padding: 0; height: 100dvh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background-color: var(--bg-body);
            font-family: 'Jua', 'Kosugi Maru', sans-serif;
            image-rendering: pixelated;
        }

        #app {
            width: min(95vw, 400px); 
            height: min(95vh, 711px); 
            background: var(--bg-game);
            border: var(--border);
            border-radius: 12px;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        .hidden { display: none !important; }

        header { 
            position: relative; 
            background: var(--primary); padding: 15px; color: #fff; 
            font-size: 1.2rem; text-align: center; border-bottom: var(--border); flex-shrink: 0;
        }

        .progress-bar { height: 16px; background: #fff; border-bottom: var(--border); flex-shrink: 0; }
        #progress-fill { height: 100%; width: 0%; background: var(--secondary); transition: 0.3s; }

        .content { 
            flex: 1; display: flex; flex-direction: column; 
            padding: 40px 20px 20px 20px; box-sizing: border-box; overflow: hidden;
        }

        .spacer { flex: 1; min-height: 20px; }

        ruby rt { 
            font-size: 0.7rem; 
            color: #6c3483; 
            font-family: 'Kosugi Maru', sans-serif;
            font-weight: bold;
            transform: translateY(-1px);
        }

        .home-star {
            font-size: 8.5rem;
            margin-bottom: 10px;
            animation: starFloat 2.5s infinite ease-in-out;
            filter: drop-shadow(0 0 20px rgba(253, 216, 53, 0.7));
        }
        @keyframes starFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(15deg); } }
        
        .main-title { font-size: 2.8rem; color: var(--primary); margin-bottom: 5px; text-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
        .sub-title { font-size: 1.1rem; color: #888; margin-bottom: 40px; letter-spacing: 1.5px; }

        .quiz-card {
            background: #fff; border: var(--border); padding: 35px 15px;
            text-align: center; position: relative; border-radius: 10px; flex-shrink: 0;
        }
        .q-tag {
            position: absolute; top: -16px; left: 50%; transform: translateX(-50%);
            background: var(--secondary); border: var(--border); padding: 6px 12px; font-size: 0.9rem;
        }
        .question { font-size: 1.4rem; line-height: 1.6; color: #333; word-break: keep-all; }

        .options { display: grid; gap: 15px; width: 100%; flex-shrink: 0; }
        
        .btn-pixel {
            padding: 18px; background: var(--primary); color: #fff; border: var(--border);
            font-family: inherit; font-size: 1.1rem; cursor: pointer;
            box-shadow: inset -4px -4px 0px rgba(0,0,0,0.3); border-radius: 10px; outline: none;
        }
        .btn-opt { background: #fff; color: #000; box-shadow: 6px 6px 0px rgba(0,0,0,0.1); }
        .btn-opt:active { background: var(--secondary); transform: translate(3px, 3px); box-shadow: none; }

        #feedback-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; 
        }
        #feedback-overlay.show { display: flex !important; }
        .modal { background: #fff; border: var(--border); width: 85%; max-height: 80%; display: flex; flex-direction: column; padding: 20px; border-radius: 15px; }
        .f-scroll { flex: 1; overflow-y: auto; background: #FFF9C4; border: 2px dashed var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 10px; }

        .score-box { background: #fff; border: var(--border); padding: 10px; text-align: center; border-radius: 10px; flex-shrink: 0; }
        .review-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex: 1; min-height: 0; padding-right: 5px; }
        .review-item { background: #fff; border: 2px solid var(--primary); padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; flex-shrink: 0; }

        .result-footer { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; flex-shrink: 0; }
        .btn-sm { padding: 12px 5px; font-size: 0.9rem; }
    
        #screen-explain .content{padding:16px 20px 16px 20px;}
        #explain-viewer{min-height:0;}
        .explain-scroll{flex:1; min-height:0; overflow-y:auto;}

        /* explainbook ìŠ¤íƒ€ì¼ */
        .exp-h2{font-weight:900; font-size:1.05rem; margin-top:6px;}
        .exp-bad{margin-top:10px; color:#E74C3C; font-weight:900;}
        .exp-good{margin-top:10px; color:var(--primary); font-weight:900;}
        .exp-ex{margin-top:10px; color:#333;}
        .exp-ex b{font-weight:900;}
    
        /* explain footer fixed */
        #screen-explain .content{overflow:hidden;}
        #explain-viewer{display:flex; flex-direction:column; flex:1; min-height:0;}
        #explain-meta{flex-shrink:0;}
        .explain-scroll{flex:1; min-height:0; overflow-y:auto;}
        .explain-footer{flex-shrink:0; margin-top:10px;}

    
        /* explain UI tuning */
        #screen-explain .content{padding:16px 20px 14px 20px;}
        #explain-viewer{gap:0;}
        #explain-meta{margin-bottom:6px;}
        #explain-card{line-height:1.7;}
        .label{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:2px solid #000; border-radius:999px; font-weight:900; font-size:0.95rem; margin-top:14px;}
        .label.bad{background:rgba(231,76,60,0.12); color:#C0392B;}
        .label.why{background:rgba(142,68,173,0.12); color:#6C3483;}
        .label.good{background:rgba(39,174,96,0.12); color:#1E8449;}
        .label.up{background:rgba(149,165,166,0.18); color:#2c2c2c;}
        .label.sum{background:rgba(253,216,53,0.18); color:#2c2c2c;}
        .section-block{margin-top:8px;}
        .section-block ul{margin:8px 0 0 18px; padding:0;}
        .section-block li{margin:8px 0;}
        .sum-box{margin-top:14px; padding:12px; border:var(--border); border-radius:14px; background:#fff;}

    </style>
</head>
<body>

<div id="app">
    <div id="screen-home" class="content" style="justify-content:center; align-items:center; background: radial-gradient(circle, #FFFDE7 0%, #F5F7FF 100%);">
        <div class="home-star">ğŸŒŸ</div>
        <div class="main-title">ë³„ë¹›ë…¸íŠ¸</div>
        <div class="sub-title">ğŸ’¥ì¼ë³¸ì–´ ê³µë¶€ ë½€ê°œê¸°ğŸ’¥</div>
        <button class="btn-pixel" style="width:85%; background:#8E44AD;" onclick="showScreen('screen-category')">ë„ì „ ì‹œì‘!</button>
    </div>

    <div id="screen-category" class="hidden">
        <header>ë¶„ì•¼ ì„ íƒ</header>
        <div class="content" style="justify-content:center;">
            <div style="display:grid; gap:20px;">
                <button class="btn-pixel" style="background:#F39C12" onclick="startQuiz('kanji')">ğŸ‰ í•œì</button>
                <button class="btn-pixel" style="background:#3498DB" onclick="startQuiz('expression')">ğŸ“– í‘œí˜„</button>
                <button class="btn-pixel" style="background:#95a5a6" onclick="openExplainMenu()">ğŸ“š í•´ì„¤ì§‘</button>
            </div>
            <button class="btn-pixel btn-opt" style="margin-top:50px;" onclick="showScreen('screen-home')">í™ˆìœ¼ë¡œ</button>
        </div>
    </div>

    <div id="screen-explain" class="hidden">
        <header>í•´ì„¤ì§‘</header>
        <div class="content">
            <div id="explain-menu" style="display:grid; gap:15px; margin-top:20px;">
                <button class="btn-pixel" style="background:#F39C12" onclick="startExplainSection('particle')">ğŸ“ ì¡°ì‚¬</button>
                <button class="btn-pixel" style="background:#3498DB" onclick="startExplainSection('keigo')">ğŸ™‡ ê²½ì–´</button>
                <button class="btn-pixel" style="background:#27AE60" onclick="startExplainSection('word')">ğŸ ì–´íœ˜</button>
                <div class="spacer"></div>
                <button class="btn-pixel btn-opt" onclick="showScreen('screen-category')">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="explain-viewer" class="hidden" style="display:flex; flex-direction:column; flex:1; min-height:0;">
                <div id="explain-meta" style="text-align:center; color:var(--primary); margin-bottom:10px; font-weight:bold;"></div>
                <div class="quiz-card explain-scroll" style="padding:20px 15px; text-align:left;">
                    <div id="explain-card" class="question" style="font-size:1rem;"></div>
                </div>
                <div style="height:10px;"></div>
                <div class="explain-footer" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <button class="btn-pixel" onclick="prevExplain()">â—€ ì´ì „</button>
                    <button class="btn-pixel btn-opt" onclick="openExplainMenu()">ëª©ë¡</button>
                    <button class="btn-pixel" onclick="nextExplain()">ë‹¤ìŒ â–¶</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-quiz" class="hidden">
        <header id="quiz-header">ì§„í–‰ ì¤‘
</header>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <div class="content">
            <div class="quiz-card">
                <span class="q-tag" id="q-label">STEP 01</span>
                <div class="question" id="q-text"></div>
            </div>
            <div class="spacer"></div>
            <div class="options">
                <button class="btn-pixel btn-opt" id="opt0"></button>
                <button class="btn-pixel btn-opt" id="opt1"></button>
            </div>
            <div style="height:26px;"></div>
            <div style="display:flex; justify-content:center;">
                <button class="btn-pixel btn-opt" style="width:60%; background:#95a5a6; color:#000; padding:12px 10px; font-size:0.95rem;" onclick="quitQuiz()">ê·¸ë§Œí’€ê¸°</button>
            </div>
        </div>
    </div>

    <div id="feedback-overlay">
        <div class="modal">
            <span id="f-mark" style="font-size:3.5rem; text-align:center;">ğŸŒŸ</span>
            <div id="f-title" style="font-size: 1.4rem; font-weight: bold; text-align:center; margin:10px 0;"></div>
            <div class="f-scroll"><div id="f-exp" style="line-height:1.7; font-size:1.1rem; word-break: keep-all;"></div></div>
            <button class="btn-pixel" onclick="handleContinue()">ê³„ì†í•˜ê¸° â–¶</button>
        </div>
    </div>

    <div id="screen-result" class="hidden">
        <header>ê²°ê³¼ ë¦¬í¬íŠ¸</header>
        <div class="content" style="justify-content: flex-start; padding-top: 20px;">
            <div class="score-box">
                ëª¨ì€ ë³„ ê°œìˆ˜: <span id="res-c" style="color:var(--primary); font-size:2.2rem;">0</span>/5
            </div>
            <div style="text-align:center; font-size:0.9rem; color:#666; margin-top: 5px;">(í´ë¦­í•˜ë©´ í•´ì„¤ì´ ë³´ì…ë‹ˆë‹¤)</div>
            <div id="review-list" class="review-list"></div>
            <div class="result-footer">
                <button class="btn-pixel btn-sm" style="background:#95a5a6;" onclick="showScreen('screen-home')">ì²˜ìŒìœ¼ë¡œ</button>
                <button class="btn-pixel btn-sm" style="background:#3498DB;" onclick="showScreen('screen-category')">ë¶„ì•¼ ì„ íƒ</button>
                <button class="btn-pixel btn-sm" id="btn-retry-bottom" onclick="retryCurrentQuiz()">ë‹¤ì‹œí’€ê¸°</button>
                <button class="btn-pixel btn-sm" style="background:#27AE60;" onclick="continuePlay()">ê³„ì†í’€ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    var masterDB = { kanji: [], expression: [] };
    var explainDB = { particle: [], keigo: [], word: [] };
</script>

<script src="data/kanji.js"></script>
<script src="data/expression.js"></script>
<script src="data/explain.js"></script>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSnd(t) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination); const n = audioCtx.currentTime;
        if(t==='c'){ o.type='square'; o.frequency.setValueAtTime(659,n); o.frequency.setValueAtTime(987,n+0.1); g.gain.setValueAtTime(0.1,n); }
        else { o.type='sawtooth'; o.frequency.setValueAtTime(150,n); o.frequency.exponentialRampToValueAtTime(50, n+0.4); g.gain.setValueAtTime(0.1,n); }
        o.start(n); o.stop(n+0.4);
    }

    let curCat = '', qSet = [], history = [], curIdx = 0, score = 0;
    let explainSection = null, explainCards = [], explainIndex = 0;

    function showScreen(id) {
        ['screen-home', 'screen-category', 'screen-quiz', 'screen-result', 'screen-explain'].forEach(s => {
            document.getElementById(s).classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }

    function startQuiz(cat, isRetry = false) {
        curCat = cat;
        if (!window.masterDB[cat] || window.masterDB[cat].length === 0) { alert("ë¬¸ì œê°€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
        if (!isRetry) qSet = [...window.masterDB[cat]].sort(() => 0.5 - Math.random()).slice(0, 5);
        curIdx = 0; score = 0; history = [];
        const t = {kanji:'ğŸ‰ í•œì', expression:'ğŸ“– í‘œí˜„'};
        document.getElementById('quiz-header').childNodes[0].nodeValue = t[cat];
        showScreen('screen-quiz');
        render();
    }

    function render() {
        const d = qSet[curIdx];
        let optionsData = [{ text: d.o[0], isCorrect: (d.a === 0) }, { text: d.o[1], isCorrect: (d.a === 1) }];
        optionsData.sort(() => Math.random() - 0.5);
        document.getElementById('q-label').innerText = `STEP 0${curIdx + 1}`;
        document.getElementById('q-text').innerHTML = d.q;
        document.getElementById('progress-fill').style.width = `${(curIdx / 5) * 100}%`;
        const b0 = document.getElementById('opt0'), b1 = document.getElementById('opt1');
        b0.innerHTML = `A. ${optionsData[0].text}`;
        b1.innerHTML = `B. ${optionsData[1].text}`;
        b0.onclick = function() { handleCheck(optionsData[0].isCorrect); };
        b1.onclick = function() { handleCheck(optionsData[1].isCorrect); };
        document.getElementById('feedback-overlay').classList.remove('show');
    }

    function handleCheck(isC) {
        const d = qSet[curIdx]; 
        if(isC) { score++; playSnd('c'); } else { playSnd('w'); }
        history.push({...d, isC: isC});
        document.getElementById('f-mark').innerText = isC ? "ğŸŒŸ" : "â˜ï¸";
        document.getElementById('f-title').innerText = isC ? "ì •ë‹µì…ë‹ˆë‹¤!" : "ì•„ì‰¬ì›Œìš”!";
        document.getElementById('f-title').style.color = isC ? "var(--primary)" : "#E74C3C";
        document.getElementById('f-exp').innerHTML = `<b>ì •ë‹µ: ${d.o[d.a]}</b><br><br>${d.e}`;
        document.getElementById('feedback-overlay').classList.add('show');
    }

    function handleContinue() {
        document.getElementById('feedback-overlay').classList.remove('show');
        curIdx++; if(curIdx < 5) render(); else showFinalResult();
    }

    function showFinalResult() {
        showScreen('screen-result');
        document.getElementById('res-c').innerText = score;
        const list = document.getElementById('review-list'); 
        list.innerHTML = "";
        history.forEach((item, i) => {
            const div = document.createElement('div'); div.className = 'review-item';
            div.innerHTML = `<b>${i+1}. ${item.q}</b><br><span style="color:${item.isC?'var(--primary)':'#E74C3C'}">âœ… ì •ë‹µ: ${item.o[item.a]}</span>`;
            div.onclick = () => {
                document.getElementById('f-title').innerText = "í•´ì„¤ ë³µìŠµ";
                document.getElementById('f-exp').innerHTML = `<b>ë¬¸ì œ: ${item.q}</b><br><br><b>ì •ë‹µ: ${item.o[item.a]}</b><br><br>${item.e}`;
                document.getElementById('feedback-overlay').classList.add('show');
            };
            list.appendChild(div);
        });
    }

    function retryCurrentQuiz() { startQuiz(curCat, true); }
function quitQuiz() { showScreen('screen-category'); }
    function continuePlay() { startQuiz(curCat, false); }

    function openExplainMenu() {
        showScreen('screen-explain');
        document.getElementById('explain-menu').classList.remove('hidden');
        document.getElementById('explain-viewer').classList.add('hidden');
    }

    function startExplainSection(sectionKey) {
        // sectionKey: particle | keigo | word
        const map = { particle: "ì¡°ì‚¬ ì‚¬ìš©", keigo: "ê²½ì–´ì™€ í†¤", word: "ë‹¨ì–´ ì„ íƒ" };
        const cat = map[sectionKey];

        const db = window.masterExplainDB || [];
        explainCards = db.filter(x => x.category === cat);
        explainIndex = 0;

        if (explainCards.length === 0) { alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }

        document.getElementById('explain-menu').classList.add('hidden');
        document.getElementById('explain-viewer').classList.remove('hidden');
        renderExplainCard();
    }

    function renderExplainCard() {
        const meta = document.getElementById('explain-meta');
        const card = document.getElementById('explain-card');
        const c = explainCards[explainIndex];

        meta.innerText = `${explainIndex + 1}/${explainCards.length}`;

        const fixList = (c.fix || []).map(x => `<li>${x}</li>`).join("");

        card.innerHTML = `
          <div class="exp-h2">${c.title}</div>

          <div class="label bad">âŒ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜</div>
          <div class="section-block">${c.wrong}</div>

          <div class="label why">ğŸ” ì™œ ì–´ìƒ‰í• ê¹Œ</div>
          <div class="section-block">${c.why}</div>

          <div class="label good">âœ… ì´ë ‡ê²Œ ë§í•´ìš”</div>
          <div class="section-block">
            <ul>
              ${fixList}
            </ul>
          </div>

          <div class="label up">â• í•œ ë‹¨ê³„ ë”</div>
          <div class="section-block">${c.stepup}</div>

          <div class="label sum">ğŸ§· í•µì‹¬ë§Œ</div>
          <div class="sum-box">${c.summary}</div>
        `;
}

    function prevExplain() {
        if (!explainCards.length) return;
        explainIndex = (explainIndex - 1 + explainCards.length) % explainCards.length;
        renderExplainCard();
    }
    function nextExplain() {
        if (!explainCards.length) return;
        explainIndex = (explainIndex + 1) % explainCards.length;
        renderExplainCard();
    }
</script>
</body>
</html>