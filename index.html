<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>별빛노트: 일본어 뽀개기</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #DDE2FF; 
            --bg-game: #FFFDE7; 
            --primary: #8E44AD; 
            --secondary: #FDD835; 
            --border: 4px solid #000;
        }

        html, body {
            margin: 0; padding: 0; height: 100dvh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background-color: var(--bg-body);
            font-family: 'Jua', 'Kosugi Maru', sans-serif;
            image-rendering: pixelated;
        }

        #app {
            width: min(95vw, 400px); 
            height: min(95vh, 711px); 
            background: var(--bg-game);
            border: var(--border);
            border-radius: 12px;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        .hidden { display: none !important; }

        header { 
            position: relative; 
            background: var(--primary); padding: 15px; color: #fff; 
            font-size: 1.2rem; text-align: center; border-bottom: var(--border); flex-shrink: 0;
        }

        .progress-bar { height: 16px; background: #fff; border-bottom: var(--border); flex-shrink: 0; }
        #progress-fill { height: 100%; width: 0%; background: var(--secondary); transition: 0.3s; }

        .content { 
            flex: 1; display: flex; flex-direction: column; 
            padding: 40px 20px 20px 20px; box-sizing: border-box; overflow: hidden;
        }

        /* UI 고정: 마진 확보용 Spacer */
        .spacer { flex: 1; min-height: 20px; }

        /* 루비 크기 축소 (0.7rem) */
        ruby rt { 
            font-size: 0.7rem; 
            color: #6c3483; 
            font-family: 'Kosugi Maru', sans-serif;
            font-weight: bold;
            transform: translateY(-1px);
        }

        /* --- 오프닝 애니메이션 --- */
        .home-star {
            font-size: 8.5rem;
            margin-bottom: 10px;
            animation: starFloat 2.5s infinite ease-in-out;
            filter: drop-shadow(0 0 20px rgba(253, 216, 53, 0.7));
        }
        @keyframes starFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(15deg); } }
        
        .main-title {
            font-size: 2.8rem;
            color: var(--primary);
            margin-bottom: 5px;
            text-shadow: 3px 3px 0px rgba(0,0,0,0.1);
        }
        .sub-title {
            font-size: 1.1rem;
            color: #888;
            margin-bottom: 40px;
            letter-spacing: 1.5px;
        }

        .quiz-card {
            background: #fff; border: var(--border); padding: 35px 15px;
            text-align: center; position: relative; border-radius: 10px; flex-shrink: 0;
        }
        .q-tag {
            position: absolute; top: -16px; left: 50%; transform: translateX(-50%);
            background: var(--secondary); border: var(--border); padding: 6px 12px; font-size: 0.9rem;
        }
        .question { font-size: 1.4rem; line-height: 1.6; color: #333; word-break: keep-all; }

        .options { display: grid; gap: 15px; width: 100%; flex-shrink: 0; }
        
        .btn-pixel {
            padding: 18px; background: var(--primary); color: #fff; border: var(--border);
            font-family: inherit; font-size: 1.1rem; cursor: pointer;
            box-shadow: inset -4px -4px 0px rgba(0,0,0,0.3); border-radius: 10px;
            outline: none;
        }
        .btn-opt { background: #fff; color: #000; box-shadow: 6px 6px 0px rgba(0,0,0,0.1); }
        .btn-opt:active { background: var(--secondary); transform: translate(3px, 3px); box-shadow: none; }

        /* 해설 모달 최우선 순위 */
        #feedback-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; 
        }
        #feedback-overlay.show { display: flex !important; }
        .modal { background: #fff; border: var(--border); width: 85%; max-height: 80%; display: flex; flex-direction: column; padding: 20px; border-radius: 15px; }
        .f-scroll { flex: 1; overflow-y: auto; background: #FFF9C4; border: 2px dashed var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 10px; }

        .score-box { background: #fff; border: var(--border); padding: 10px; text-align: center; border-radius: 10px; flex-shrink: 0; }
        .review-list { margin: 15px 0; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex: 1; min-height: 0; padding-right: 5px; }
        .review-item { background: #fff; border: 2px solid var(--primary); padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; flex-shrink: 0; }

        .result-footer { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; flex-shrink: 0; }
        .btn-sm { padding: 12px 5px; font-size: 0.9rem; }
    
        /* explainbook-connected */
        #explain-body ruby rt{font-size:0.7rem;}
        #explain-body .sec{margin-top:10px; font-weight:900;}
        #explain-body .bad{margin-top:8px; font-weight:900; color:#E74C3C;}
        #explain-body .good{margin-top:10px; font-weight:900; color:#27AE60;}
        #explain-body .sum{margin-top:10px; padding:10px; border:var(--border); border-radius:14px; background:#fff;}
        #explain-body ul{margin:6px 0 0 18px; padding:0;}
        #explain-body li{margin:6px 0;}
    </style>
</head>
<body>

<div id="app">
    <div id="screen-home" class="content" style="justify-content:center; align-items:center; background: radial-gradient(circle, #FFFDE7 0%, #F5F7FF 100%);">
        <div class="home-star">🌟</div>
        <div class="main-title">별빛노트</div>
        <div class="sub-title">일본어 뽀개기</div>
        <button class="btn-pixel" style="width:85%; background:#8E44AD;" onclick="showScreen('screen-category')">도전 시작!</button>
    </div>

    <div id="screen-category" class="hidden">
        <header>분야 선택</header>
        <div class="content" style="justify-content:center;">

            <div style="display:grid; gap:20px;">
                <button class="btn-pixel" style="background:#F39C12" onclick="startQuiz('kanji')">🉐 한자</button>
                <button class="btn-pixel" style="background:#3498DB" onclick="startQuiz('expression')">📖 표현</button>
                <button class="btn-pixel" style="background:#95a5a6" onclick="openExplainMenu()">📚 해설집</button>
            </div>

            <button class="btn-pixel btn-opt" style="margin-top:50px;" onclick="showScreen('screen-home')">홈으로</button>
        </div>
</div>
            <div class="spacer"></div>
            <button class="btn-pixel btn-opt" style="width:85%;" onclick="showScreen('screen-category')">뒤로가기</button>
        </div>
    </div>

</div>

    
    <div id="screen-explain" class="hidden">
        <header id="explain-header">해설집
            <button class="btn-pixel btn-sm" style="position:absolute; right:10px; top:8px; background:#95a5a6; padding:10px 10px;" onclick="showScreen('screen-category')">닫기</button>
        </header>
        <div class="content" style="justify-content:flex-start; padding-top:14px; gap:14px;">

            <div id="explain-menu" class="quiz-card" style="padding:16px;">
                <div class="question" style="font-size:1.1rem;">📚 목차</div>
                <div style="margin-top:10px; display:grid; gap:10px;">
                    <button class="btn-pixel btn-opt" style="width:100%; background:#3498DB;" onclick="startExplain('조사 사용')">자주 틀리는 표현 - 조사 사용</button>
                    <button class="btn-pixel btn-opt" style="width:100%; background:#9B59B6;" onclick="startExplain('경어와 톤')">자주 틀리는 표현 - 경어와 톤</button>
                    <button class="btn-pixel btn-opt" style="width:100%; background:#E67E22;" onclick="startExplain('단어 선택')">더 자연스러운 표현 - 단어 선택</button>
                </div>
                <div style="margin-top:12px; font-size:0.92rem; color:#666; line-height:1.4;">
                    ※ 카테고리를 선택하면 카드가 1장씩 표시됩니다. 아래 버튼으로 넘기며 읽을 수 있습니다.
                </div>
            </div>

            <div id="explain-viewer" class="quiz-card hidden" style="padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                    <div id="explain-title" class="question" style="font-size:1.05rem; line-height:1.3;"></div>
                    <div id="explain-meta" style="font-weight:900; color:#666;"></div>
                </div>

                <div style="height:10px;"></div>
                <div id="explain-body" style="line-height:1.55; font-size:0.98rem;"></div>

                <div style="height:12px;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <button class="btn-pixel btn-sm" onclick="prevExplainCard()">＜</button>
                    <button class="btn-pixel btn-sm" onclick="openExplainMenu()">홈으로</button>
                    <button class="btn-pixel btn-sm" onclick="nextExplainCard()">＞</button>
                </div>
            </div>

        </div>
    </div>


    <div id="screen-quiz" class="hidden">
        <header id="quiz-header">진행 중<button class="btn-pixel btn-sm" style="position:absolute; right:110px; top:8px; background:#F39C12; padding:10px 10px;" onclick="goHomeFromQuiz()">홈</button><button class="btn-pixel btn-sm" style="position:absolute; right:10px; top:8px; background:#95a5a6; padding:10px 10px;" onclick="quitQuiz()">그만풀기</button></header>
        <div class="progress-bar"><div id="progress-fill"></div></div>
        <div class="content">
            <div class="quiz-card">
                <span class="q-tag" id="q-label">STEP 01</span>
                <div class="question" id="q-text">질문을 불러오는 중...</div>
            </div>
            <div class="spacer"></div>
            <div class="options">
                <button class="btn-pixel btn-opt" id="opt0"></button>
                <button class="btn-pixel btn-opt" id="opt1"></button>
            </div>
        </div>
    </div>

    <div id="feedback-overlay">
        <div class="modal">
            <span id="f-mark" style="font-size:3.5rem; text-align:center;">🌟</span>
            <div id="f-title" style="font-size: 1.4rem; font-weight: bold; text-align:center; margin:10px 0;"></div>
            <div class="f-scroll"><div id="f-exp" style="line-height:1.7; font-size:1.1rem; word-break: keep-all;"></div></div>
            <button class="btn-pixel" onclick="handleContinue()">계속하기 ▶</button>
        </div>
    </div>

    <div id="screen-result" class="hidden">
        <header>결과 리포트</header>
        <div class="content" style="justify-content: flex-start; padding-top: 20px;">
            <div class="score-box">
                모은 별 개수: <span id="res-c" style="color:var(--primary); font-size:2.2rem;">0</span>/5
            </div>
            <div style="text-align:center; font-size:0.9rem; color:#666; margin-top: 5px;">(클릭하면 해설이 보입니다)</div>
            
            <div id="review-list" class="review-list"></div>
            <div class="result-footer">
                <button class="btn-pixel btn-sm" style="background:#95a5a6;" onclick="showScreen('screen-home')">처음으로</button>
                <button class="btn-pixel btn-sm" style="background:#3498DB;" onclick="showScreen('screen-category')">분야 선택</button>
                <button class="btn-pixel btn-sm" id="btn-retry-bottom" onclick="retryCurrentQuiz()">다시풀기</button>
                <button class="btn-pixel btn-sm" style="background:#27AE60;" onclick="continuePlay()">계속풀기</button>
            </div>
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSnd(t) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination); const n = audioCtx.currentTime;
        if(t==='c'){ o.type='square'; o.frequency.setValueAtTime(659,n); o.frequency.setValueAtTime(987,n+0.1); g.gain.setValueAtTime(0.1,n); }
        else { o.type='sawtooth'; o.frequency.setValueAtTime(150,n); o.frequency.exponentialRampToValueAtTime(50, n+0.4); g.gain.setValueAtTime(0.1,n); }
        o.start(n); o.stop(n+0.4);
    }

    // --- 마스터 DB (60문항 풀 버전 & 순수 일본어 루비 & 장문 해설) ---
    const masterDB = {
        kanji: [
            {q:"<ruby>舞台<rt>ぶたい</rt></ruby>의 뜻은?", o:["무대","객석"], a:0, e: "<b>무대</b>를 의미합니다. '춤출 무(舞)'와 '대 대(台)'를 사용하여 아티스트가 자신의 기량을 펼치는 장소를 나타냅니다. 산하님이 팬들 앞에서 가장 빛나는 장소이기도 하죠. 공연장뿐만 아니라 연극, 뮤지컬 등 예술 활동이 일어나는 공간을 총칭합니다."},
            {q:"<ruby>笑顔<rt>えがお</rt></ruby>의 뜻은?", o:["미소","눈물"], a:0, e: "<b>미소(웃는 얼굴)</b>를 뜻합니다. '웃다(笑う)'와 '얼굴(顔)'이 합쳐진 단어로, 단순한 웃음보다 밝고 화사한 표정을 강조할 때 주로 사용합니다. 아티스트의 행복한 표정은 팬들에게 큰 에너지를 줍니다."},
            {q:"<ruby>勇気<rt>ゆうき</rt></ruby>의 뜻은?", o:["용기","끈기"], a:0, e: "<b>용기</b>를 뜻합니다. 어려움에 맞서 나아가는 강한 마음을 의미하며, '용기를 내다'는 '勇気を出す'라고 표현합니다. 새로운 도전을 할 때 반드시 필요한 소중한 마음가짐입니다."},
            {q:"<ruby>奇跡<rt>きせき</rt></ruby>의 뜻은?", o:["기적","행운"], a:0, e: "<b>기적</b>을 뜻합니다. 상식적으로 일어날 수 없는 신비한 일을 말하며, 팬들이 아티스트와 만난 소중한 인연을 표현할 때 자주 사용합니다. '기적을 믿다'는 '奇跡を信じる'라고 합니다."},
            {q:"<ruby>永遠<rt>えいえん</rt></ruby>의 뜻은?", o:["영원","순간"], a:0, e: "<b>영원</b>을 뜻합니다. 시간의 끝이 없이 계속되는 상태를 나타내며, 아티스트와 팬 사이의 변치 않는 유대감을 상징하는 단어입니다. '영원히 응원하다'는 문장에서 핵심적인 어휘입니다."},
            {q:"<ruby>約束<rt>やくそく</rt></ruby>의 뜻은?", o:["약속","예약"], a:0, e: "<b>약속</b>을 뜻합니다. 일본어에서는 손가락을 걸고 약속한다는 의미의 '指切り(ゆびきり)'와 함께 자주 쓰입니다. 공연에서 다시 만나기로 하는 다짐 등 신뢰를 바탕으로 한 상황에 사용됩니다."},
            {q:"<ruby>景色<rt>けしき</rt></ruby>의 뜻은?", o:["풍경","그림"], a:0, e: "<b>경치(풍경)</b>를 뜻합니다. 눈앞에 펼쳐진 시각적인 모습을 묘사할 때 쓰며, 무대 위에서 아티스트가 바라보는 응원봉의 물결을 표현할 때 아주 잘 어울리는 단어입니다."},
            {q:"<ruby>希望<rt>きぼう</rt></ruby>의 뜻은?", o:["희망","열망"], a:0, e: "<b>희망</b>을 뜻합니다. 앞날에 대한 밝은 기대를 담고 있으며, 아티스트가 가사를 통해 팬들에게 전하고 싶은 긍정적인 메시지의 핵심 키워드 중 하나입니다."},
            {q:"<ruby>感動<rt>かんどう</rt></ruby>의 뜻은?", o:["감동","감각"], a:0, e: "<b>감동</b>을 뜻합니다. 마음이 깊이 움직이는 것을 의미하며, 아름다운 노래나 훌륭한 연기를 보았을 때 느끼는 벅찬 감정을 표현할 때 일본어로 '感動した'라고 합니다."},
            {q:"<ruby>努力<rt>どりょく</rt></ruby>의 뜻은?", o:["노력","능력"], a:0, e: "<b>노력</b>을 뜻합니다. 목적을 달성하기 위해 애쓰는 과정을 말하며, 산하님이 데뷔 전부터 지금까지 성장해온 원동력을 가장 잘 나타내는 단어입니다."},
            {q:"<ruby>準備<rt>じゅんび</rt></ruby>의 뜻은?", o:["준비","연습"], a:0, e: "<b>준비</b>를 뜻합니다. 어떤 일을 하기 전에 미리 필요한 것을 갖추는 과정입니다. 완벽한 무대를 보여주기 위해 뒤에서 철저히 준비하는 시간을 의미합니다."},
            {q:"<ruby>記憶<rt>きおく</rt></ruby>의 뜻은?", o:["기억","기록"], a:0, e: "<b>기억</b>을 뜻합니다. 과거의 경험을 마음속에 남겨두는 것으로, 팬들과 함께 보낸 소중한 시간을 잊지 말자는 의미에서 '大切な記憶'이라는 표현으로 자주 사용됩니다."},
            {q:"<ruby>信頼<rt>しんらい</rt></ruby>의 뜻은?", o:["신뢰","의뢰"], a:0, e: "<b>신뢰</b>를 뜻합니다. 믿고 의지하는 마음을 의미하며, 오랜 시간 쌓아온 아티스트와 팬 사이의 단단한 유대감을 상징하는 무거운 가치를 지닌 단어입니다."},
            {q:"<ruby>挑戦<rt>ちょうせん</rt></ruby>의 뜻은?", o:["도전","응전"], a:0, e: "<b>도전</b>을 뜻합니다. 새로운 영역에 발을 들이거나 한계를 극복하려는 의지를 담고 있습니다. 장르를 가리지 않는 산하님의 활발한 활동을 응원할 때 쓰기 좋습니다."},
            {q:"<ruby>未来<rt>みらい</rt></ruby>의 뜻은?", o:["미래","과거"], a:0, e: "<b>미래</b>를 뜻합니다. 앞으로 다가올 시간이며, 아직 오지 않았기에 무한한 가능성이 열려 있음을 상징합니다. 밝은 내일을 꿈꾸는 모든 상황에 어울리는 어휘입니다."},
            {q:"<ruby>感謝<rt>かんしゃ</rt></ruby>의 뜻은?", o:["감사","사과"], a:0, e: "<b>감사</b>를 뜻합니다. 고마운 마음을 전하는 가장 기본적인 표현이며, 일본어로는 '感謝の気持ち(감사의 마음)'라는 구절로 자주 사용됩니다."},
            {q:"<ruby>成長<rt>せいちょう</rt></ruby>의 뜻은?", o:["성장","성공"], a:0, e: "<b>성장</b>을 뜻합니다. 실력이나 인격이 향상되는 것을 의미하며, 데뷔 초기와 비교해 몰라보게 성숙해진 아티스트의 모습을 묘사할 때 가장 적절한 단어입니다."},
            {q:"<ruby>成功<rt>せいこう</rt></ruby>의 뜻은?", o:["성공","시도"], a:0, e: "<b>성공</b>을 뜻합니다. 뜻한 바를 이루어내는 것을 말하며, 앨범 흥행이나 투어의 성황리에 마침을 축하할 때 일본어로 '成功おめでとう'라고 말합니다."},
            {q:"<ruby>幸福<rt>こうふく</rt></ruby>의 뜻은?", o:["행복","축복"], a:0, e: "<b>행복</b>을 뜻합니다. 마음이 충족되어 즐거운 상태를 말하며, 일상어인 '幸せ'보다 문어체적이고 격식 있는 표현입니다."},
            {q:"<ruby>情熱<rt>じょうねつ</rt></ruby>의 뜻은?", o:["열정","친절"], a:0, e: "<b>열정</b>을 뜻합니다. 어떤 일에 온 마음을 다해 뜨겁게 몰입하는 힘을 의미하며, 무대 위 뜨거운 퍼포먼스를 묘사할 때 필수적인 단어입니다."}
        ],
        grammar: [
            {q:"'노래하고 있습니다'의 표현?", o:["<ruby>歌<rt>うた</rt></ruby>っています","<ruby>歌<rt>うた</rt></ruby>います"], a:0, e: "동사의 <b>진행형</b>(~하고 있다)입니다. 동사의 'て형' 뒤에 'いる'가 붙어 현재 진행 중인 동작을 나타냅니다. 정중형은 'います'가 되어 '노래하고 있습니다'가 됩니다."},
            {q:"'가고 싶어요'의 표현?", o:["<ruby>行<rt>い</rt></ruby>きたい입니다","<ruby>行<rt>い</rt></ruby>きます"], a:0, e: "자신의 바람을 나타내는 <b>희망 표현</b>입니다. 동사의ます형 어간에 '~たい'를 붙여 '~하고 싶다'라는 뜻을 만듭니다. '공연에 가고 싶다'는 'ライブに行きたい'라고 합니다."},
            {q:"'별이' 빛난다 (조사)?", o:["<ruby>星<rt>ほし</rt></ruby>가","<ruby>星<rt>ほし</rt></ruby>를"], a:0, e: "주격 조사 <b>'가(が)'</b>입니다. 문장의 주체를 나타낼 때 사용하며, '별이(星が)'와 같이 대상을 지정하여 강조하는 느낌을 줍니다."},
            {q:"'기타를' 친다 (조사)?", o:["<ruby>ギター<rt>ぎたー</rt></ruby>を","<ruby>ギター<rt>ぎたー</rt></ruby>が"], a:0, e: "목적격 조사 <b>'을/를(を)'</b>입니다. 동작의 대상을 나타낼 때 사용하며, '기타를' 연주하는 동작의 대상임을 명확히 합니다."},
            {q:"'먹지 않습니다' (부정)?", o:["<ruby>食<rt>た</rt></ruby>べません","<ruby>食<rt>た</rt></ruby>べました"], a:0, e: "동사의 <b>부정 정중형</b>입니다. '~ます' 대신 '~ません'을 붙여 정중하게 거절하거나 사실을 부정할 때 사용합니다."},
            {q:"'이미' 했어요 (완료)?", o:["もう","まだ"], a:0, e: "완료를 나타내는 부사 <b>'이미/벌써(もう)'</b>입니다. 어떤 동작이 이미 끝났거나 새로운 상태에 도달했음을 나타낼 때 사용합니다. 반대어는 '아직'이라는 뜻의 'まだ'입니다."},
            {q:"'~하고 나서' (순서)?", o:["~てから","~ながら"], a:0, e: "동작의 <b>순서</b>를 나타내는 표현입니다. 앞의 행동이 완료된 후 다음 행동이 이어짐을 명확히 합니다. '공연이 끝나고 나서' 등으로 쓰입니다."},
            {q:"'~하면서' (동시)?", o:["~ながら","~てから"], a:0, e: "두 가지 동작을 <b>동시에</b> 수행함을 나타냅니다. '노래하면서 춤추다'와 같이 화려한 퍼포먼스를 묘사할 때 필수적인 표현입니다."},
            {q:"'할 수 있다' (가능)?", o:["~ことができる","~ます"], a:0, e: "동작의 <b>가능</b>을 나타내는 표현입니다. 동사의 사전형 뒤에 'ことができる'를 붙여 능력이 있거나 상황이 허락됨을 의미합니다."},
            {q:"'매우' 좋아해요?", o:["とても","あまり"], a:0, e: "긍정의 <b>강조</b>를 나타내는 부사입니다. '아주, 매우'라는 뜻으로 감정이나 상태의 정도를 높여 표현합니다. '너무 좋아해'는 'とても好き'라고 합니다."},
            {q:"'어디에' 있나요?", o:["どこに","ここに"], a:0, e: "장소를 묻는 <b>의문사</b> '어디(どこ)'입니다. 궁금한 위치를 질문할 때 사용하며, 정중하게 물을 때는 'どこですか'라고 합니다."},
            {q:"'~가 있다' (생물)?", o:["います","あります"], a:0, e: "사람이나 동물과 같이 <b>살아있는 존재</b>가 있음을 나타냅니다. 무대 위에 아티스트가 있을 때는 'います'를 사용해야 합니다."},
            {q:"'~가 있다' (무생물)?", o:["あります","います"], a:0, e: "식물이나 물건과 같이 <b>생명이 없는 존재</b>가 있음을 나타냅니다. 무대 위에 기타가 있을 때는 'あります'를 사용합니다."},
            {q:"'귀여운' 강아지?", o:["<ruby>可愛<rt>かわい</rt></ruby>い","<ruby>静<rt>しず</rt></ruby>かだ"], a:0, e: "상태를 묘사하는 <b>이-형용사</b>입니다. 끝이 'い'로 끝나며 명사를 직접 수식합니다. 매력을 표현할 때 가장 많이 듣게 되는 단어입니다."},
            {q:"'~합시다' (권유)?", o:["~ましょう","~ます"], a:0, e: "상대방에게 함께 행동할 것을 <b>권유</b>하는 표현입니다. '~합시다'라는 뜻으로, 팬들에게 '함께 즐겨요'라고 말할 때 사용합니다."},
            {q:"'~라면' (가정)?", o:["~たら","~て"], a:0, e: "조건을 나타내는 <b>가정 표현</b>입니다. 어떤 상황이 성립한다면 다음 행동을 하겠다는 의지를 담고 있습니다. '만약 만날 수 있다면' 등의 문장에 쓰입니다."},
            {q:"'~하기 쉽다'?", o:["~やすい","~にくい"], a:0, e: "동작의 <b>용이함</b>을 나타냅니다. 동사의 ます형 뒤에 붙어 '~하기 편하다, ~하기 쉽다'라는 의미를 추가합니다. 반대말은 어렵다는 뜻의 '~にくい'입니다."},
            {q:"'누구' 입니까?", o:["だれ","なに"], a:0, e: "사람을 묻는 <b>의문사</b> '누구(だれ)'입니다. 정중하게 표현할 때는 '어느 분'이라는 뜻의 'どなた'를 사용하기도 합니다."},
            {q:"'무엇' 입니까?", o:["なに","だれ"], a:0, e: "사물을 묻는 <b>의문사</b> '무엇(なに)'입니다. '무엇을 하고 있나요?'와 같은 구체적인 정보를 요구하는 질문에 사용됩니다."},
            {q:"'아직' 안 왔어요?", o:["まだ","もう"], a:0, e: "동작이나 상태의 미완료를 나타내는 <b>미완료</b> 부사입니다. '아직 멀었나요?'와 같은 질문에서 자주 등장합니다."}
        ],
        honor: [
            {q:"'영광입니다' 경어?", o:["<ruby>光栄<rt>こうえい</rt></ruby>です","<ruby>嬉<rt>うれ</rt></ruby>しいです"], a:0, e: "격식 있는 시상식이나 큰 무대에서 사용하는 <b>정중한 경어</b>입니다. 상대방에게 감사를 표하며 자신의 현재 위치에 대한 예우를 다할 때 사용합니다."},
            {q:"'식사 하셨나요' 존경?", o:["<ruby>召<rt>め</rt></ruby>し<ruby>上<rt>あ</rt></ruby>がりましたか","<ruby>食<rt>た</rt></ruby>べましたか"], a:0, e: "'먹다'의 <b>존경어</b>인 '召し上がる'를 사용한 최고의 예우 표현입니다. 아티스트의 건강을 걱정하는 팬들이 가장 정중하게 안부를 묻는 방법입니다."},
            {q:"'기다리겠습니다' 겸양?", o:["お<ruby>待<rt>ま</rt></ruby>ちしております","<ruby>待<rt>ま</rt></ruby>っています"], a:0, e: "자신을 낮추어 상대방에 대한 존경을 표하는 <b>겸양 표현</b>입니다. '기다리다'를 더욱 격식 있게 말하여 팬들의 방문을 고대하고 있음을 전할 때 씁니다."},
            {q:"'잠시 기다려주세요'?", o:["<ruby>少々<rt>しょうしょう</rt></ruby>お<ruby>待<rt>ま</rt></ruby>ちください","ちょっと<ruby>待<rt>ま</rt></ruby>って"], a:0, e: "비즈니스나 공식적인 안내에서 사용되는 <b>격식 경어</b>입니다. '조금'을 뜻하는 'ちょっと' 대신 '少々'를 사용하여 차분하고 정중한 분위기를 만듭니다."},
            {q:"'알겠습니다' 격식?", o:["かしこまりました","わかりました"], a:0, e: "상대방의 지시나 정보를 확실히 인지했음을 알리는 <b>최상급 수락 경어</b>입니다. 단순한 이해를 넘어 상대방을 극진히 모시는 마음이 담긴 표현입니다."},
            {q:"'말씀하시다' 존경?", o:["おっしゃる","<ruby>言<rt>い</rt></ruby>う"], a:0, e: "'말하다(言う)'의 <b>존경어</b>입니다. 아티스트의 말 한마디 한마디를 소중히 여기며 높여 부를 때 '산하님이 말씀하시길'과 같은 상황에서 사용합니다."},
            {q:"'뵙다' 겸양어?", o:["お<ruby>目<rt>메</rt></ruby>にかかる","<ruby>会<rt>あ</rt></ruby>う"], a:0, e: "'만나다(会う)'의 <b>겸양어</b>입니다. 동경하는 아티스트를 직접 만날 수 있게 된 영광스러운 상황을 아주 겸손하고 정중하게 표현하는 아름다운 어휘입니다."},
            {q:"'수고하셨습니다' 표준?", o:["お<ruby>疲<rt>つか</rt></ruby>れ<ruby>様<rt>さま</rt></ruby>でした","ご<ruby>苦労<rt>くろう</rt></ruby>さま"], a:0, e: "상대방의 노고를 격려하는 <b>표준 정중 인사</b>입니다. 상급자나 동료에게 두루 쓸 수 있으며, 공연 후 함께 고생한 스태프들에게 전하는 따뜻한 인사입니다."},
            {q:"'실례하겠습니다'?", o:["<ruby>失礼<rt>しつれい</rt></ruby>します","さようなら"], a:0, e: "예의 바른 입장이나 퇴장을 알릴 때 사용하는 <b>격식 경어</b>입니다. 상대방의 공간에 들어가거나 대화를 마무리할 때 예절을 지키는 필수 표현입니다."},
            {q:"'어떻게 생각하시나요'?", o:["いかがお<ruby>思<rt>おも</rt></ruby>이ですか","どう<ruby>思<rt>お도</rt></ruby>いますか"], a:0, e: "상대의 의견을 <b>정중히 묻는 표현</b>입니다. '어떻게(どう)' 대신 'いかが'를 사용하여 질문의 품격을 높였으며, 상대방의 생각을 존중하는 태도를 보여줍니다."},
            {q:"'드셔보세요' 권유?", o:["<ruby>召<rt>め</rt></ruby>し<ruby>上<rt>あ</rt></ruby>がってみてください","<ruby>食<rt>た</rt></ruby>べてみて"], a:0, e: "음식을 정중하게 <b>권하는 존경 표현</b>입니다. 상대방이 맛있는 음식을 기분 좋게 즐기기를 바라는 배려의 마음이 담긴 따뜻한 권유의 말입니다."},
            {q:"'전하겠습니다' 겸양?", o:["<ruby>申<rt>もう</rt></ruby>し<ruby>伝<rt>つた</rt></ruby>えます","<ruby>伝<rt>つた</rt></ruby>えます"], a:0, e: "자신이 메시지를 전달하는 행위를 낮추어 표현하는 <b>겸양어</b>입니다. 팬의 소중한 마음을 아티스트에게 전하겠다고 약속할 때 사용하는 정중한 약속의 언어입니다."},
            {q:"'성함' 존경어?", o:["お<ruby>名前<rt>なまえ</rt></ruby>","<ruby>名前<rt>なまえ</rt></ruby>"], a:0, e: "상대방의 이름을 높여 부르는 <b>미화어(경어)</b>입니다. 단어 앞에 'お'를 붙여 그 대상이 소중한 존재임을 문법적으로 나타내는 일본어 특유의 예절입니다."},
            {q:"'잘 오셨습니다'?", o:["よくいらっしゃいました","よく<ruby>来<rt>き</rt></ruby>ました"], a:0, e: "먼 길을 온 손님을 극진히 환영하는 <b>존경 인사</b>입니다. 공연장에 찾아준 팬들을 향해 아티스트가 전할 수 있는 가장 반가운 환영의 메시지입니다."},
            {q:"'열심히 하겠습니다'?", o:["<ruby>精一杯<rt>せいいっぱい</rt></ruby><ruby>努<rt>つと</rt></ruby>めます","<ruby>頑張<rt>がんば</rt></ruby>ります"], a:0, e: "공식적인 포부를 밝히는 <b>정중한 다짐</b>입니다. 자신의 온 힘을 다해 직무에 임하겠다는 격조 높은 표현으로, 공연 전 인터뷰 등에서 자주 쓰입니다."},
            {q:"'안녕히 주무세요'?", o:["おやすみなさい","<ruby>寝<rt>ね</rt></ruby>るね"], a:0, e: "자기 전에 건네는 <b>정중한 작별 인사</b>입니다. 상대방이 편안한 밤을 보내기를 기원하는 예의 바른 인사말로 일상에서도 매우 자주 사용됩니다."},
            {q:"'말씀 들었습니다'?", o:["<ruby>承<rt>うけたまわ</rt></ruby>りました","<ruby>聞<rt>き</rt></ruby>きました"], a:0, e: "'듣다(聞く)'의 아주 정중한 <b>겸양어</b>입니다. 상대방의 이야기나 주문을 확실히 수용했음을 알리는 정중한 표현으로 비즈니스 매너의 기초입니다."},
            {q:"'만나 뵙게 되어'?", o:["お<ruby>目<rt>め</rt></ruby>にかかれて","<ruby>会<rt>あ</rt></ruby>えて"], a:0, e: "만남 그 자체를 영광스럽게 생각하는 <b>겸양 표현</b>입니다. '보여주다'는 뜻의 '見せる'에서 유래하여 상대방의 눈에 자신의 모습이 비치게 됨을 낮추어 말합니다."},
            {q:"'조심히 돌아가세요'?", o:["お<ruby>気<rt>き</rt></ruby>をつけてお<ruby>帰<rt>かえ</rt></ruby>리ください","<ruby>気<rt>기</rt></ruby>をつけて"], a:0, e: "상대방의 귀가길 안전을 기원하는 <b>정중한 배웅</b>입니다. 공연 관람 후 퇴장하는 팬들을 향해 아티스트가 건넬 수 있는 가장 다정한 예의의 한마디입니다."},
            {q:"'보여드리다' 겸양?", o:["お<ruby>見<rt>み</rt></ruby>せします","<ruby>見<rt>み</rt></ruby>せます"], a:0, e: "자신의 무대나 결과물을 상대방에게 제시하는 행위를 낮추는 <b>겸양어</b>입니다. 공들여 준비한 퍼포먼스를 팬들에게 선보일 때 사용하는 예의 바른 고백입니다."}
        ]
    };

    // 표현 카테고리: 기존 문법+경어를 합쳐서 사용
    masterDB.expression = [...(masterDB.grammar || []), ...(masterDB.honor || [])];

    let curCat = '', qSet = [], history = [], curIdx = 0, score = 0;

    function showScreen(id) {
        ['screen-home', 'screen-category', 'screen-quiz', 'screen-result', 'screen-explain'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function startQuiz(cat, isRetry = false) {
        curCat = cat;
        if (!isRetry) qSet = [...masterDB[cat]].sort(() => 0.5 - Math.random()).slice(0, 5);
        curIdx = 0; score = 0; history = [];
        const t = {kanji:'🉐 한자', expression:'📖 표현'};
        document.getElementById('quiz-header').innerText = t[cat];
        showScreen('screen-quiz');
        render();
    }

    function render() {
        const d = qSet[curIdx];
        
        // 선택지 셔플 로직 적용
        let optionsData = [
            { text: d.o[0], isCorrect: (d.a === 0) },
            { text: d.o[1], isCorrect: (d.a === 1) }
        ];
        optionsData.sort(() => Math.random() - 0.5);

        document.getElementById('q-label').innerText = `STEP 0${curIdx + 1}`;
        document.getElementById('q-text').innerHTML = d.q;
        document.getElementById('progress-fill').style.width = `${(curIdx / 5) * 100}%`;

        const b0 = document.getElementById('opt0');
        const b1 = document.getElementById('opt1');
        
        b0.innerHTML = `A. ${optionsData[0].text}`;
        b1.innerHTML = `B. ${optionsData[1].text}`;
        
        // 클릭 함수 연결 (직접 할당하여 버그 방지)
        b0.onclick = function() { handleCheck(optionsData[0].isCorrect); };
        b1.onclick = function() { handleCheck(optionsData[1].isCorrect); };

        document.getElementById('feedback-overlay').classList.remove('show');
    }

    function handleCheck(isC) {
        const d = qSet[curIdx]; 
        if(isC) { score++; playSnd('c'); } else { playSnd('w'); }
        history.push({...d, isC: isC});
        
        document.getElementById('f-mark').innerText = isC ? "🌟" : "☁️";
        document.getElementById('f-title').innerText = isC ? "정답입니다!" : "아쉬워요!";
        document.getElementById('f-title').style.color = isC ? "var(--primary)" : "#E74C3C";
        document.getElementById('f-exp').innerHTML = `<b>정답: ${d.o[d.a]}</b><br><br>${d.e}`;
        
        document.getElementById('feedback-overlay').classList.add('show');
    }

    function handleContinue() {
        document.getElementById('feedback-overlay').classList.remove('show');
        curIdx++;
        if(curIdx < 5) render();
        else showFinalResult();
    }

    function showFinalResult() {
        showScreen('screen-result');
        document.getElementById('res-c').innerText = score;
        const list = document.getElementById('review-list'); 
        list.innerHTML = "";
        
        history.forEach((item, i) => {
            const div = document.createElement('div'); 
            div.className = 'review-item';
            div.innerHTML = `<b>${i+1}. ${item.q}</b><br><span style="color:${item.isC?'var(--primary)':'#E74C3C'}">✅ 정답: ${item.o[item.a]}</span>`;
            div.onclick = () => {
                document.getElementById('f-title').innerText = "해설 복습";
                document.getElementById('f-exp').innerHTML = `<b>문제: ${item.q}</b><br><br><b>정답: ${item.o[item.a]}</b><br><br>${item.e}`;
                document.getElementById('feedback-overlay').classList.add('show');
            };
            list.appendChild(div);
        });
    }

    function retryCurrentQuiz() { startQuiz(curCat, true); }

    function goHomeFromQuiz() {
        // 퀴즈 중 홈으로 이동
        document.getElementById('feedback-overlay').classList.remove('show');
        showScreen('screen-home');
    }

    function quitQuiz() {
        // 문제 풀이 중단 → 분야 선택으로 이동
        document.getElementById('feedback-overlay').classList.remove('show');
        showScreen('screen-category');
    }

    function continuePlay() {
        // 같은 분야로 새 5문항 계속 풀기
        startQuiz(curCat, false);
    }


    // ===== 해설집 연결 (masterExplainDB) =====
    // GitHub Pages에서는 아래 모듈 import가 정상 동작합니다.
    // 로컬 file://로 열면 모듈 import가 차단될 수 있습니다.
</script>
<script type="module">
    import masterExplainDB from './별빛노트_해설카드_masterExplainDB_final.js';
    window.masterExplainDB = masterExplainDB;
</script>
<script>
    const explainState = { category: null, cards: [], idx: 0 };

    function openExplainMenu() {
        showScreen('screen-explain');
        document.getElementById('explain-menu').classList.remove('hidden');
        document.getElementById('explain-viewer').classList.add('hidden');
    }

    function startExplain(categoryName) {
        const db = window.masterExplainDB || [];
        explainState.category = categoryName;
        explainState.cards = db.filter(c => c.category === categoryName);
        explainState.idx = 0;

        document.getElementById('explain-menu').classList.add('hidden');
        document.getElementById('explain-viewer').classList.remove('hidden');

        renderExplainCard();
    }

    function renderExplainCard() {
        const titleEl = document.getElementById('explain-title');
        const metaEl = document.getElementById('explain-meta');
        const bodyEl = document.getElementById('explain-body');

        if (!explainState.cards.length) {
            titleEl.textContent = '카드가 아직 없습니다.';
            metaEl.textContent = '';
            bodyEl.innerHTML = '<div style="color:#666;">해당 카테고리 카드가 비어 있습니다.</div>';
            return;
        }

        const c = explainState.cards[explainState.idx];
        titleEl.innerHTML = c.title;
        metaEl.textContent = `${explainState.idx + 1}/${explainState.cards.length}`;

        const fixList = (c.fix || []).map(x => `<li>${x}</li>`).join('');

        bodyEl.innerHTML =
            `<div class="bad">❌ 어색한 문장 사례</div>` +
            `<div>${c.wrong}</div>` +
            `<div class="sec">🔎 왜 어색한가</div>` +
            `<div>${(c.why || '').replace(/\n\n/g, '<br><br>')}</div>` +
            `<div class="good">✅ 자연스럽게 쓰려면</div>` +
            `<ul>${fixList}</ul>` +
            `<div class="sec">🔼 ステップアップ</div>` +
            `<div>${(c.stepup || '').replace(/\n\n/g, '<br><br>')}</div>` +
            `<div class="sum"><b>📌 한 줄 정리</b><br>${c.summary}</div>`;
    }

    function prevExplainCard() {
        if (!explainState.cards.length) return;
        explainState.idx = (explainState.idx - 1 + explainState.cards.length) % explainState.cards.length;
        renderExplainCard();
    }

    function nextExplainCard() {
        if (!explainState.cards.length) return;
        explainState.idx = (explainState.idx + 1) % explainState.cards.length;
        renderExplainCard();
    }
</script>
</body>
</body>
</html>
